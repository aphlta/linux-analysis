# RISC-V arch_cpu_idle() noinstr 修复分析

## 1. Commit 信息

**Commit ID**: 8a48ea87ce89  
**标题**: riscv: Fix warning by declaring arch_cpu_idle() as noinstr  
**作者**: Alexandre Ghiti <alexghiti@rivosinc.com>  
**日期**: 2024年3月26日  
**Fixes**: cfbc4f81c9d0 ("riscv: Select ARCH_WANTS_NO_INSTR")  

## 2. 问题描述

### 2.1 错误现象

当RISC-V架构启用`ARCH_WANTS_NO_INSTR`配置后，在CPU空闲时会触发以下警告：

```
[89855.452929] status: 0000000200000100 badaddr: 0000000000000000 cause: 0000000000000003
[89855.453053] [<ffffffff8016b216>] arch_ftrace_ops_list_func+0x208/0x228
[89855.453191] [<ffffffff8000e082>] ftrace_call+0x8/0x22
[89855.453265] [<ffffffff800a149c>] do_idle+0x24c/0x2ca
[89855.453357] [<ffffffff8000da54>] return_to_handler+0x0/0x26
[89855.453429] [<ffffffff8000b716>] smp_callin+0x92/0xb6
```

### 2.2 根本原因

问题的根本原因是`arch_cpu_idle()`函数被ftrace工具链插桩，但该函数在CPU空闲状态下执行，不应该被任何调试工具干扰。当启用`ARCH_WANTS_NO_INSTR`后，内核对函数插桩有更严格的要求，未标记为`noinstr`的关键函数会导致问题。

## 3. 技术原理分析

### 3.1 ARCH_WANTS_NO_INSTR机制

`ARCH_WANTS_NO_INSTR`是内核配置选项，用于指示架构需要严格控制函数插桩。如Kconfig中所述：

> "An architecture should select this if the noinstr macro is being used on functions to denote that the toolchain should avoid instrumenting such functions and is required for correctness."

### 3.2 noinstr属性作用

`noinstr`属性告诉编译器和工具链：
1. **禁止ftrace插桩**: 防止函数被ftrace跟踪
2. **禁止KASAN插桩**: 避免内存访问检查
3. **禁止KCOV插桩**: 防止代码覆盖率工具干扰
4. **禁止其他调试工具**: 确保函数执行不被打断

### 3.3 CPU空闲机制

#### 3.3.1 arch_cpu_idle()函数流程

```c
void noinstr arch_cpu_idle(void)
{
    cpu_do_idle();
}
```

#### 3.3.2 cpu_do_idle()实现

在`arch/riscv/include/asm/cpuidle.h`中定义：

```c
static inline void cpu_do_idle(void)
{
    /*
     * Add mb() here to ensure that all
     * IO/MEM accesses are completed prior
     * to entering WFI.
     */
    mb();
    wait_for_interrupt();
}
```

#### 3.3.3 WFI指令机制

`wait_for_interrupt()`最终执行RISC-V的WFI(Wait For Interrupt)指令：
- **功能**: 让CPU进入低功耗等待状态
- **唤醒条件**: 中断、异常或调试事件
- **特点**: 是特权指令，只能在机器模式或监管模式执行

### 3.4 调用链分析

完整的CPU空闲调用链：
```
do_idle() 
  → cpuidle_idle_call()
    → default_idle_call()
      → arch_cpu_idle()
        → cpu_do_idle()
          → wait_for_interrupt() // WFI指令
```

## 4. 修复方案

### 4.1 代码修改

```diff
-void arch_cpu_idle(void)
+void noinstr arch_cpu_idle(void)
 {
     cpu_do_idle();
 }
```

### 4.2 修复原理

1. **防止插桩干扰**: `noinstr`确保CPU空闲时不会被ftrace等工具打断
2. **保证原子性**: 空闲状态转换过程不被调试工具影响
3. **避免递归问题**: 防止在空闲状态下触发更多的跟踪事件

## 5. 相关提交分析

### 5.1 引入问题的提交

**Commit**: cfbc4f81c9d0 ("riscv: Select ARCH_WANTS_NO_INSTR")  
**作者**: Jisheng Zhang <jszhang@kernel.org>  
**日期**: 2023年11月23日  

该提交为RISC-V架构启用了`ARCH_WANTS_NO_INSTR`，但没有同时修复相关的函数标记，导致了本次修复的问题。

### 5.2 参考修复

**Commit**: a9cbc1b471d2 ("s390/idle: mark arch_cpu_idle() noinstr")  
**作者**: Heiko Carstens <hca@linux.ibm.com>  

S390架构遇到了相同的问题并进行了类似的修复，为RISC-V的修复提供了参考。

## 6. 影响范围

### 6.1 受影响的配置
- 启用了`ARCH_WANTS_NO_INSTR`的RISC-V系统
- 启用了ftrace功能的内核
- 多核RISC-V系统（从调用栈中的smp_callin可以看出）

### 6.2 症状表现
- CPU空闲时出现异常警告
- 可能影响系统稳定性
- 调试信息污染内核日志

## 7. 验证和测试

### 7.1 测试人员
- **Tested-by**: Andy Chiu <andy.chiu@sifive.com>
- **Reviewed-by**: Andy Chiu <andy.chiu@sifive.com>
- **Acked-by**: Puranjay Mohan <puranjay12@gmail.com>

### 7.2 报告者
- **Reported-by**: Evgenii Shatokhin <e.shatokhin@yadro.com>
- **问题链接**: https://lore.kernel.org/linux-riscv/51f21b87-ebed-4411-afbc-c00d3dea2bab@yadro.com/

## 8. 总结

这个patch解决了RISC-V架构在启用严格插桩控制后CPU空闲函数被错误插桩的问题。通过添加`noinstr`属性，确保了`arch_cpu_idle()`函数在执行时不会被ftrace等调试工具干扰，保证了CPU空闲状态转换的正确性和系统稳定性。

这是一个典型的架构适配问题，当引入新的内核特性（`ARCH_WANTS_NO_INSTR`）时，需要同步更新相关的关键函数标记，以确保系统的正确运行。