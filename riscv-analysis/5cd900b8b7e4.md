# Patch Analysis: 5cd900b8b7e4

## 基本信息

- **Commit ID**: 5cd900b8b7e4
- **标题**: riscv: use local label names instead of global ones in assembly
- **作者**: Clément Léger <cleger@rivosinc.com>
- **提交者**: Palmer Dabbelt <palmer@rivosinc.com>
- **提交日期**: 2025年1月8日
- **修复的commit**: 503638e0babf3 ("riscv: Stop emitting preventive sfence.vma for new vmalloc mappings")

## 修改内容概述

这个patch修复了RISC-V架构中汇编代码标签命名的问题，将全局标签改为本地标签，以避免符号表污染和错误的回溯信息。

### 修改的文件

- `arch/riscv/kernel/entry.S`

### 具体修改

将以下全局标签改为本地标签（添加`.L`前缀）：

1. `_new_vmalloc_restore_context_a0` → `.Lnew_vmalloc_restore_context_a0`
2. `_new_vmalloc_kernel_address` → `.Lnew_vmalloc_kernel_address`
3. `_new_vmalloc_restore_context_a1` → `.Lnew_vmalloc_restore_context_a1`
4. `_new_vmalloc_restore_context` → `.Lnew_vmalloc_restore_context`

## 技术原理分析

### 汇编标签的作用域

在汇编语言中，标签有两种类型：

1. **全局标签**：没有特殊前缀的标签会被导出到符号表中，可以被其他编译单元引用
2. **本地标签**：以`.L`开头的标签是本地标签，不会被导出到符号表中，仅在当前编译单元内可见

### 问题分析

#### 符号表污染
使用全局标签会导致这些内部使用的标签被导出到内核符号表中，这些标签本来只是汇编代码内部的跳转目标，不应该对外可见。

#### 错误的回溯信息
当内核发生异常时，回溯信息会显示最近的符号。如果使用了全局标签，回溯可能会显示这些内部标签而不是真正的函数名，导致调试信息不准确。

**修复前的回溯信息**：
```
[   12.751810] [<ffffffff80441628>] _copy_from_user+0x28/0xc2
[   12.752035] [<ffffffff800152ca>] handle_misaligned_load+0x1ca/0x2fc
[   12.752310] [<ffffffff80a033e8>] do_trap_load_misaligned+0x24/0xee
[   12.752596] [<ffffffff80a0dcae>] _new_vmalloc_restore_context_a0+0xc2/0xce
```

**修复后的回溯信息**：
```
[   10.243916] [<ffffffff804415e4>] _copy_from_user+0x28/0xc2
[   10.244026] [<ffffffff800152ca>] handle_misaligned_load+0x1ca/0x2fc
[   10.244150] [<ffffffff80a033a0>] do_trap_load_misaligned+0x24/0xee
[   10.244268] [<ffffffff80a0dc66>] handle_exception+0x146/0x152
```

可以看到，修复后显示的是正确的函数名`handle_exception`而不是内部标签。

### 代码上下文分析

这些标签位于`new_vmalloc_check`宏中，该宏的作用是：

1. **检查异常类型**：判断是否为页面错误（加载、存储、指令页面错误）
2. **检查地址类型**：判断是否为内核地址
3. **检查新的vmalloc映射**：检查是否有新的vmalloc映射可以解释当前的陷阱
4. **原子操作**：原子地重置当前CPU在new_vmalloc中的位
5. **内存屏障**：根据需要发出sfence.vma指令

这个宏在异常处理的早期阶段被调用，用于处理可能的vmalloc映射问题。

## 相关提交分析

### 被修复的提交：503638e0babf3

**标题**: "riscv: Stop emitting preventive sfence.vma for new vmalloc mappings"

**背景**：
- 在Linux 6.5中，移除了vmalloc故障路径，因为它无法正常工作
- 为了确保页表遍历器能看到新的页表项，需要在所有hart上预防性地发出sfence.vma
- 这种解决方案成本很高，因为它依赖于IPI（处理器间中断）
- 可能导致vmalloc故障循环，特别是在IPI路径中进行vmalloc分配时

**解决方案**：
- 移除预防性的sfence.vma
- 实际处理可能的（且不太可能的）异常
- 在异常处理的早期阶段处理，避免故障路径中的vmalloc分配

### 修复的必要性

503638e0babf3引入了`new_vmalloc_check`宏和相关的汇编标签，但使用了全局标签命名，导致了符号表污染和错误的回溯信息。当前的patch修复了这个问题。

## 影响分析

### 正面影响

1. **清理符号表**：移除不必要的全局符号，减少符号表大小
2. **改善调试体验**：提供更准确的回溯信息，便于内核调试
3. **符合编码规范**：遵循汇编代码的最佳实践

### 兼容性

- **二进制兼容性**：不影响，因为这些标签本来就不应该被外部引用
- **调试工具**：可能需要更新依赖这些符号的调试工具（如果有的话）

## 代码审查

### 审查者
- Alexandre Ghiti <alexghiti@rivosinc.com>

### 审查意见
审查者认可了这个修复，确认了本地标签的使用是正确的做法。

## 总结

这是一个代码质量改进的patch，主要解决了：

1. **符号表污染问题**：将内部使用的汇编标签从全局改为本地
2. **调试信息准确性**：确保内核回溯显示正确的函数名
3. **代码规范性**：遵循汇编代码的最佳实践

虽然这个修改看起来很小，但对于内核调试和维护来说是很重要的改进。它确保了内核符号表的清洁性和调试信息的准确性，这对于内核开发者来说是非常有价值的。

## 相关链接

- **Patch链接**: https://lore.kernel.org/r/20250103141814.508865-1-cleger@rivosinc.com
- **被修复的commit**: 503638e0babf3
- **相关讨论**: Linux RISC-V邮件列表