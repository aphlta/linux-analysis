# Patch Analysis: 26f2d6de4179

## 基本信息

**Commit ID:** 26f2d6de41795a931d1c16950114dbcf55dfbd75  
**标题:** riscv: defconfig: drop RT_GROUP_SCHED=y  
**作者:** Celeste Liu <coelacanthushex@gmail.com>  
**提交者:** Palmer Dabbelt <palmer@rivosinc.com>  
**提交日期:** 2024年12月27日  
**作者日期:** 2024年9月10日  

## 修改内容详述

### 文件修改

**文件:** `arch/riscv/configs/defconfig`

**修改内容:**
```diff
@@ -10,7 +10,6 @@ CONFIG_MEMCG=y
 CONFIG_BLK_CGROUP=y
 CONFIG_CGROUP_SCHED=y
 CONFIG_CFS_BANDWIDTH=y
-CONFIG_RT_GROUP_SCHED=y
 CONFIG_CGROUP_PIDS=y
 CONFIG_CGROUP_FREEZER=y
 CONFIG_CGROUP_HUGETLB=y
```

**修改说明:** 从RISC-V架构的默认内核配置中移除了`CONFIG_RT_GROUP_SCHED=y`配置项。

## 技术原理分析

### RT_GROUP_SCHED功能概述

`RT_GROUP_SCHED`（Real-Time Group Scheduling）是Linux内核中的一个调度器功能，用于为实时任务组提供CPU带宽分配控制。

**核心功能:**
1. **实时任务组调度:** 允许为不同的cgroup分配固定的实时CPU带宽
2. **带宽隔离:** 确保实时任务组之间的CPU时间分配互不干扰
3. **资源保证:** 为每个实时任务组提供确定性的CPU时间保证

### 配置依赖关系

根据`init/Kconfig`中的定义:
```kconfig
config RT_GROUP_SCHED
	bool "Group scheduling for SCHED_RR/FIFO"
	depends on CGROUP_SCHED
	default n
	help
	  This feature lets you explicitly allocate real CPU bandwidth
	  to task groups. If enabled, it will also make it impossible to
	  schedule realtime tasks for non-root users until you allocate
	  realtime bandwidth for them.
```

**关键特性:**
- 依赖于`CGROUP_SCHED`
- 默认值为`n`（禁用）
- 影响非root用户的实时任务调度

### RT_GROUP_SCHED的问题

#### 1. Cgroup v1的问题
- **强制预算分配:** 任何在"cpu"层次结构中的cgroup都需要分配RT预算
- **配置复杂性:** 需要同时设置上限和下限时间限制
- **绝对值要求:** 所有cgroup的预算总和必须小于1
- **无默认值:** 无法提供适用于一般情况的默认预算值

#### 2. Cgroup v2的问题
- **功能限制:** 启用时，只有当所有RT进程都在root cgroup中时，cpu控制器才能启用
- **失去优势:** 如果所有RT进程都在同一个cgroup中，就失去了cgroup v2的优势

#### 3. 实际使用问题
- **用户体验差:** 非root用户无法运行实时任务，除非管理员预先分配带宽
- **系统不稳定:** 配置不当可能导致系统不稳定
- **维护困难:** 需要管理员深入了解实时调度原理

## 修改原因分析

### 1. Docker需求变化

**历史背景:**
- 原始引入: commit `ba6cfef057e1` (2022年6月) 为了满足Docker的要求而引入
- Docker移除需求: 2023年4月19日，Docker已经移除了对`RT_GROUP_SCHED`的要求
- 参考链接: https://github.com/moby/moby/commit/005150ed69c540fb0b5323e0f2208608c1204536

### 2. 主流发行版的选择

**禁用RT_GROUP_SCHED的发行版:**
- Red Hat
- Gentoo  
- Arch Linux
- Debian

**系统软件支持:**
- systemd也不支持RT_GROUP_SCHED
- 参考: https://github.com/systemd/systemd/issues/13781#issuecomment-549164383

### 3. 技术问题

**Red Hat Bug报告:**
- Bug ID: https://bugzilla.redhat.com/show_bug.cgi?id=1229700
- 描述了RT_GROUP_SCHED在实际使用中的配置困难

## 相关提交分析

### 原始引入提交: ba6cfef057e1

**提交信息:**
- 标题: "riscv: enable Docker requirements in defconfig"
- 作者: Heinrich Schuchardt <heinrich.schuchardt@canonical.com>
- 日期: 2022年6月8日
- 目的: 使defconfig内核能够运行Docker

**引入的配置项:**
除了`RT_GROUP_SCHED`外，还引入了大量Docker相关的配置，包括:
- 网络相关: `NETFILTER_*`, `IP_VS`, `BRIDGE`, `VLAN_8021Q`等
- 存储相关: `MD`, `BLK_DEV_DM`, `DM_THIN_PROVISIONING`等
- 虚拟化相关: `DUMMY`, `MACVLAN`, `IPVLAN`, `VXLAN`, `VETH`等
- 安全相关: `SECURITY_SELINUX`, `SECURITY_APPARMOR`等

### 当前移除提交: 26f2d6de4179

**审核过程:**
- Acked-by: Heinrich Schuchardt <heinrich.schuchardt@canonical.com> (原始引入者同意)
- Acked-by: Charlie Jenkins <charlie@rivosinc.com>
- Signed-off-by: Palmer Dabbelt <palmer@rivosinc.com> (维护者签名)

**邮件列表讨论:**
- Link: https://lore.kernel.org/r/20240910-fix-riscv-rt_group_sched-v3-1-486e75e5ae6d@gmail.com
- 版本: v3，说明经过了多轮讨论和修改

## 影响评估

### 正面影响

1. **简化配置:** 移除了复杂且难以正确配置的功能
2. **提高稳定性:** 避免了RT_GROUP_SCHED可能导致的系统不稳定问题
3. **改善用户体验:** 非root用户可以正常运行实时任务
4. **与主流一致:** 与主要Linux发行版的配置保持一致
5. **满足现代需求:** Docker等容器技术不再需要此功能

### 潜在风险

1. **实时任务隔离:** 失去了对实时任务组进行CPU带宽隔离的能力
2. **向后兼容性:** 依赖RT_GROUP_SCHED的应用可能受到影响
3. **特殊用例:** 某些需要严格实时保证的嵌入式应用可能需要重新配置

### 缓解措施

1. **手动启用:** 有特殊需求的用户仍可以在自定义内核配置中启用
2. **替代方案:** 可以使用其他调度策略和优先级机制
3. **文档说明:** 内核文档中有详细的配置说明

## 结论

这个patch是一个合理的配置优化，主要原因包括:

1. **需求变化:** Docker等主要用户已不再需要此功能
2. **实用性问题:** RT_GROUP_SCHED在实际使用中存在配置复杂、易出错等问题
3. **行业趋势:** 主流Linux发行版都已禁用此功能
4. **维护考虑:** 移除减少了维护负担和用户困惑

该修改不会影响大多数用户的使用，同时提高了系统的稳定性和易用性。对于有特殊实时调度需求的用户，仍可以通过自定义内核配置来启用此功能。

## 参考资料

1. [Docker移除RT_GROUP_SCHED需求的提交](https://github.com/moby/moby/commit/005150ed69c540fb0b5323e0f2208608c1204536)
2. [Red Hat相关Bug报告](https://bugzilla.redhat.com/show_bug.cgi?id=1229700)
3. [systemd关于RT_GROUP_SCHED的讨论](https://github.com/systemd/systemd/issues/13781#issuecomment-549164383)
4. [Linux内核实时组调度文档](Documentation/scheduler/sched-rt-group.rst)
5. [邮件列表讨论](https://lore.kernel.org/r/20240910-fix-riscv-rt_group_sched-v3-1-486e75e5ae6d@gmail.com)