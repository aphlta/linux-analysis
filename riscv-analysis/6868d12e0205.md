# Patch Analysis: 6868d12e0205

## 基本信息

**Commit ID:** 6868d12e0205  
**作者:** Jisheng Zhang <jszhang@kernel.org>  
**提交时间:** 2023年  
**标题:** riscv: errata: sifive: Use SYM_*() assembly macros  

## 修改内容概述

这个patch将SiFive CIP-453 errata处理代码中的汇编宏从已弃用的`ENTRY()`/`END()`替换为新的`SYM_FUNC_START()`/`SYM_FUNC_END()`宏。

### 具体修改

**文件:** `arch/riscv/errata/sifive/errata_cip_453.S`

**修改前:**
```assembly
ENTRY(sifive_cip_453_page_fault_trp)
    // 函数实现
END(sifive_cip_453_page_fault_trp)

ENTRY(sifive_cip_453_insn_fault_trp)
    // 函数实现
END(sifive_cip_453_insn_fault_trp)
```

**修改后:**
```assembly
SYM_FUNC_START(sifive_cip_453_page_fault_trp)
    // 函数实现
SYM_FUNC_END(sifive_cip_453_page_fault_trp)

SYM_FUNC_START(sifive_cip_453_insn_fault_trp)
    // 函数实现
SYM_FUNC_END(sifive_cip_453_insn_fault_trp)
```

## 技术原理分析

### 1. 汇编宏的演进

#### 旧的ENTRY/END宏
- `ENTRY()`: 定义全局符号入口点，设置对齐
- `END()`: 标记符号结束
- 这些宏在`include/linux/linkage.h`中被标记为已弃用

#### 新的SYM_*宏
- `SYM_FUNC_START()`: 明确标识函数开始，提供更好的符号注释
- `SYM_FUNC_END()`: 明确标识函数结束
- 这些宏提供了更精确的符号类型信息，有助于调试器和分析工具

### 2. 宏定义分析

根据`include/linux/linkage.h`的定义：

```c
// 旧宏（已弃用）
#define ENTRY(name) SYM_FUNC_START(name)
#define ENDPROC(name) SYM_FUNC_END(name)

// 新宏
#define SYM_FUNC_START(name) \
    SYM_START(name, SYM_L_GLOBAL, SYM_A_ALIGN)

#define SYM_FUNC_END(name) \
    SYM_END(name, SYM_T_FUNC)
```

### 3. SiFive CIP-453 Errata背景

#### 硬件缺陷描述
SiFive CIP-453是一个影响特定SiFive处理器核心的硬件缺陷：

- **影响的处理器:** Architecture ID: 0x8000000000000007
- **影响的版本范围:** Implement ID 在 0x20181004 到 0x20191105 之间
- **缺陷性质:** 与页面错误和指令错误处理相关的硬件bug

#### Errata处理机制
1. **检测阶段:** 系统启动时通过`errata_cip_453_check_func`检查CPU ID
2. **应用阶段:** 如果检测到受影响的CPU，使用`patch_text_nosync`动态替换错误处理函数
3. **替换目标:**
   - `do_trap_insn_fault` → `sifive_cip_453_insn_fault_trp`
   - `do_page_fault` → `sifive_cip_453_page_fault_trp`

### 4. 代码实现细节

#### ADD_SIGN_EXT宏
```assembly
.macro ADD_SIGN_EXT pt_reg badaddr_reg tmp_reg
    REG_L \tmp_reg, PT_BADADDR(\pt_reg)
    li \badaddr_reg, 1
    slli \badaddr_reg, \badaddr_reg, 0x26
    and \tmp_reg, \tmp_reg, \badaddr_reg
    beqz \tmp_reg, 1f
    li \badaddr_reg, -1
    slli \badaddr_reg, \badaddr_reg, 0x27
    REG_L \tmp_reg, PT_BADADDR(\pt_reg)
    or \tmp_reg, \tmp_reg, \badaddr_reg
    REG_S \tmp_reg, PT_BADADDR(\pt_reg)
1:
.endm
```

这个宏实现了符号扩展逻辑，用于修复硬件缺陷导致的地址计算错误。

## 相关提交分析

### 1. 主要相关提交

#### 76329c693924 - "riscv: Use SYM_*() assembly macros"
- **范围更广:** 转换了多个文件中的汇编宏
- **影响文件:**
  - `arch/riscv/lib/string.S`
  - `arch/riscv/lib/uaccess.S`
  - `arch/riscv/purgatory/entry.S`
- **引入新宏:** `SYM_FUNC_ALIAS_WEAK`, `SYM_FUNC_ALIAS`, `SYM_CODE_START`, `SYM_CODE_END`, `SYM_DATA`

#### 7c9d980e4670 - "riscv: select ARCH_USE_SYM_ANNOTATIONS"
- **配置更改:** 在`arch/riscv/Kconfig`中添加`select ARCH_USE_SYM_ANNOTATIONS`
- **效果:** 确保RISC-V架构使用新的符号注释系统，禁用已弃用的宏

#### 9b2863e2cc46 - 合并提交
- **类型:** Merge commit
- **标题:** "Merge patch series 'riscv: select ARCH_USE_SYM_ANNOTATIONS'"
- **意义:** 将整个符号注释转换系列合并到主线

### 2. 提交时间线

```
76329c693924 - 主要转换提交
6868d12e0205 - SiFive errata特定转换
7c9d980e4670 - 启用ARCH_USE_SYM_ANNOTATIONS
9b2863e2cc46 - 合并提交
```

## 影响和意义

### 1. 代码质量提升
- **符号信息:** 新宏提供更精确的符号类型信息
- **调试支持:** 改善调试器和分析工具的支持
- **一致性:** 与内核其他部分的符号注释保持一致

### 2. 维护性改进
- **标准化:** 使用统一的符号定义标准
- **未来兼容:** 为未来的工具链改进做准备
- **清理工作:** 移除已弃用的宏使用

### 3. 架构层面
- **RISC-V现代化:** 使RISC-V架构符合现代内核标准
- **工具链支持:** 更好地支持现代开发工具
- **符号可见性:** 改善符号在各种工具中的可见性

## 总结

这个patch是RISC-V架构现代化工作的一部分，将SiFive CIP-453 errata处理代码从已弃用的汇编宏转换为新的符号注释系统。虽然功能上没有变化，但这种转换提高了代码质量，改善了工具支持，并确保了与内核其他部分的一致性。这个修改是更大规模的RISC-V符号注释标准化工作的组成部分。