# Patch Analysis: 07863871dfb1

## 基本信息

**Commit ID:** 07863871dfb1162965b21bb8c2e4861bdb0019da3
**作者:** Jinyu Tang <tangjinyu@tinylab.org>
**提交日期:** 2023年9月12日
**标题:** riscv: defconfig : add CONFIG_MMC_DW for starfive
**维护者:** Palmer Dabbelt <palmer@rivosinc.com>
**审核者:** Conor Dooley <conor.dooley@microchip.com>

## Patch 概述

这个patch为RISC-V架构的默认配置文件添加了两个MMC相关的配置选项，专门用于支持StarFive JH7110 SoC的SD卡功能。

## 详细分析

### 1. 修改内容

**文件:** `arch/riscv/configs/defconfig`

**添加的配置项:**
```
+CONFIG_MMC_DW=y
+CONFIG_MMC_DW_STARFIVE=y
```

**插入位置:** 在现有MMC配置项之间，具体在`CONFIG_MMC_SPI=y`之后，`CONFIG_MMC_SDHI=y`之前。

### 2. 技术背景

#### 2.1 Synopsys DesignWare MMC控制器
- `CONFIG_MMC_DW` 启用Synopsys DesignWare Mobile Storage IP块的支持
- 这是一个通用的MMC/SD卡控制器IP，被多个SoC厂商采用
- 支持PIO模式、内部DMA模式和外部DMA模式

#### 2.2 StarFive特定扩展
- `CONFIG_MMC_DW_STARFIVE` 启用StarFive JH7110 SoC特定的扩展
- 驱动文件位于: `drivers/mmc/host/dw_mmc-starfive.c`
- 支持StarFive JH7110 SoC的特定时序和相位调整功能

### 3. 问题解决

#### 3.1 问题描述
- 在没有这些配置的情况下，JH7110 SoC无法正常运行MMC功能
- 使用SD卡作为rootfs时，系统无法找到根文件系统
- StarFive VisionFive 2 (VF2) 开发板无法使用主线内核配置启动SD卡系统

#### 3.2 解决方案
- 参考ARM64架构的defconfig配置，ARM64已经启用了`CONFIG_MMC_DW=y`
- 添加StarFive特定的配置`CONFIG_MMC_DW_STARFIVE=y`
- 使得VF2开发板可以使用主线defconfig和设备树启动SD卡rootfs

### 4. 驱动实现细节

#### 4.1 StarFive驱动特性
- **设备兼容性:** `starfive,jh7110-mmc`
- **特殊时序处理:** 支持MMC_TIMING_MMC_DDR52和MMC_TIMING_UHS_DDR50
- **时钟管理:** 动态调整时钟频率，DDR模式下可设置100MHz时钟
- **相位调整:** 支持采样相位调整，提高数据传输可靠性
- **调谐功能:** 实现execute_tuning回调，优化信号时序

#### 4.2 关键功能
```c
static const struct dw_mci_drv_data starfive_data = {
    .common_caps        = MMC_CAP_CMD23,
    .set_ios            = dw_mci_starfive_set_ios,
    .execute_tuning     = dw_mci_starfive_execute_tuning,
};
```

### 5. 配置依赖关系

#### 5.1 CONFIG_MMC_DW
- **依赖:** `ARC || ARM || ARM64 || MIPS || RISCV || CSKY || COMPILE_TEST`
- **功能:** 启用Synopsys DesignWare Memory Card Interface支持
- **选择:** `MMC_DW_PLTFM` (平台设备支持)

#### 5.2 CONFIG_MMC_DW_STARFIVE
- **依赖:** `SOC_STARFIVE && MMC_DW`
- **选择:** `MMC_DW_PLTFM`
- **功能:** StarFive JH7110 SoC特定扩展

### 6. 与其他架构的对比

#### 6.1 ARM64 defconfig
ARM64架构已经包含了多个DW MMC驱动配置:
```
CONFIG_MMC_DW=y
CONFIG_MMC_DW_EXYNOS=y
CONFIG_MMC_DW_HI3798CV200=y
CONFIG_MMC_DW_K3=y
CONFIG_MMC_DW_ROCKCHIP=y
```

#### 6.2 RISC-V defconfig (修改后)
```
CONFIG_MMC_DW=y
CONFIG_MMC_DW_STARFIVE=y
```

### 7. 相关提交历史

这个patch是StarFive JH7110 SoC支持的一部分，相关的提交包括:
- StarFive设备树支持
- StarFive时钟驱动
- StarFive MMC驱动实现
- StarFive SoC基础架构支持

### 8. 测试和验证

#### 8.1 测试平台
- **硬件:** StarFive VisionFive 2 (VF2) 开发板
- **SoC:** StarFive JH7110
- **存储:** SD卡作为rootfs

#### 8.2 测试结果
- 启用配置后，VF2开发板可以成功从SD卡启动
- 系统能够正确识别和挂载SD卡根文件系统
- MMC控制器工作正常，支持标准SD卡操作

### 9. 影响范围

#### 9.1 正面影响
- 使StarFive JH7110 SoC获得完整的SD卡支持
- 提高RISC-V生态系统的硬件兼容性
- 简化VF2开发板的使用配置

#### 9.2 潜在风险
- 增加内核镜像大小（影响很小）
- 对不使用StarFive硬件的系统无影响

### 10. 总结

这是一个简单但重要的配置修改，解决了StarFive JH7110 SoC在主线Linux内核中的SD卡支持问题。通过添加两个配置选项，使得VisionFive 2开发板能够使用标准的RISC-V defconfig启动，提高了用户体验和硬件兼容性。这个patch体现了开源社区对新兴RISC-V硬件平台的支持，有助于RISC-V生态系统的发展。

### 11. 技术要点

- **最小化修改:** 只添加必要的配置选项，不影响现有功能
- **遵循惯例:** 参考ARM64的配置方式，保持一致性
- **特定优化:** 针对StarFive硬件的特殊需求进行配置
- **向后兼容:** 不影响现有RISC-V系统的功能