# Patch Analysis: f5102e31c209

## 1. 基本信息

**Commit ID:** f5102e31c209798cafd2d79463f5093771aadc12  
**作者:** Locus Wei-Han Chen <locus84@andestech.com>  
**提交日期:** Thu Feb 22 16:39:46 2024 +0800  
**标题:** riscv: andes: Support specifying symbolic firmware and hardware raw events  
**签名者:** Palmer Dabbelt <palmer@rivosinc.com>  

## 2. Patch 概述

这个patch为RISC-V架构的Andes AX45处理器添加了PMU（Performance Monitoring Unit）事件的符号化支持。通过添加JSON配置文件，使得perf工具能够使用符号化的事件名称来代替原始的硬件事件代码，大大提升了性能分析的易用性。

## 3. 修改内容详细分析

### 3.1 新增文件列表

1. `tools/perf/pmu-events/arch/riscv/andes/ax45/firmware.json` (68行)
2. `tools/perf/pmu-events/arch/riscv/andes/ax45/instructions.json` (127行)
3. `tools/perf/pmu-events/arch/riscv/andes/ax45/memory.json` (57行)
4. `tools/perf/pmu-events/arch/riscv/andes/ax45/microarch.json` (77行)
5. `tools/perf/pmu-events/arch/riscv/mapfile.csv` (修改1行)

**总计:** 330行新增代码

### 3.2 firmware.json 分析

该文件定义了22个固件相关的标准事件，主要包括：

#### 3.2.1 内存访问事件
- `FW_MISALIGNED_LOAD`: 非对齐加载访问
- `FW_MISALIGNED_STORE`: 非对齐存储访问
- `FW_ACCESS_LOAD`: 加载访问
- `FW_ACCESS_STORE`: 存储访问
- `FW_ILLEGAL_INSN`: 非法指令

#### 3.2.2 系统调用事件
- `FW_SET_TIMER`: 设置定时器
- `FW_IPI_SENT/RECEIVED`: 处理器间中断发送/接收

#### 3.2.3 内存管理事件
- `FW_FENCE_I_SENT/RECEIVED`: 指令fence操作
- `FW_SFENCE_VMA_*`: 虚拟内存地址fence操作
- `FW_HFENCE_GVMA_*`: 客户机虚拟内存地址fence操作（虚拟化支持）
- `FW_HFENCE_VVMA_*`: 虚拟化虚拟内存地址fence操作

### 3.3 instructions.json 分析

该文件定义了指令执行相关的性能计数器，包含以下类别：

#### 3.3.1 基础计数器
- `cycle_count` (0x10): 周期计数
- `inst_count` (0x20): 退休指令计数

#### 3.3.2 整数指令
- `int_load_inst` (0x30): 整数加载指令
- `int_store_inst` (0x40): 整数存储指令
- `int_compute_inst` (0x70): 整数计算指令
- `int_mul_inst` (0xF0): 整数乘法指令
- `int_div_rem_inst` (0x100): 整数除法/取余指令
- `int_mul_add_sub_inst` (0x180): 整数乘加/减指令

#### 3.3.3 浮点指令
- `float_load_inst` (0x110): 浮点加载指令
- `float_store_inst` (0x120): 浮点存储指令
- `float_add_sub_inst` (0x130): 浮点加减指令
- `float_mul_inst` (0x140): 浮点乘法指令
- `float_fused_muladd_inst` (0x150): 浮点融合乘加指令
- `float_div_sqrt_inst` (0x160): 浮点除法/开方指令
- `other_float_inst` (0x170): 其他浮点指令

#### 3.3.4 控制流指令
- `condition_br` (0x80): 条件分支指令
- `taken_condition_br` (0x90): 执行的条件分支指令
- `jal_inst` (0xA0): JAL指令
- `jalr_inst` (0xB0): JALR指令

#### 3.3.5 特殊指令
- `atomic_inst` (0x50): 原子指令
- `sys_inst` (0x60): 系统指令
- `retired_ops` (0x190): 退休操作计数

### 3.4 memory.json 分析

该文件定义了内存子系统相关的性能事件：

#### 3.4.1 本地内存访问
- `ilm_access` (0x01): 指令本地内存访问
- `dlm_access` (0x11): 数据本地内存访问

#### 3.4.2 指令缓存
- `icache_access` (0x21): 指令缓存访问
- `icache_miss` (0x31): 指令缓存缺失

#### 3.4.3 数据缓存
- `dcache_access` (0x41): 数据缓存访问
- `dcache_miss` (0x51): 数据缓存缺失
- `dcache_load_access` (0x61): 数据缓存加载访问
- `dcache_load_miss` (0x71): 数据缓存加载缺失
- `dcache_store_access` (0x81): 数据缓存存储访问
- `dcache_store_miss` (0x91): 数据缓存存储缺失
- `dcache_wb` (0xA1): 数据缓存写回

### 3.5 microarch.json 分析

该文件定义了微架构相关的性能事件：

#### 3.5.1 缓存等待周期
- `cycle_wait_icache_fill` (0xB1): 等待指令缓存填充的周期
- `cycle_wait_dcache_fill` (0xC1): 等待数据缓存填充的周期
- `cycle_wait_uncached_ifetch` (0xF1): 等待非缓存指令获取的周期
- `cycle_wait_uncached_load` (0x101): 等待非缓存加载的周期

#### 3.5.2 非缓存访问
- `uncached_ifetch_from_bus` (0xD1): 从总线进行非缓存指令获取
- `uncached_load_from_bus` (0xE1): 从总线进行非缓存加载

#### 3.5.3 TLB事件
- `main_itlb_access` (0x111): 主指令TLB访问
- `main_itlb_miss` (0x121): 主指令TLB缺失
- `main_dtlb_access` (0x131): 主数据TLB访问
- `main_dtlb_miss` (0x141): 主数据TLB缺失
- `cycle_wait_itlb_fill` (0x151): 等待指令TLB填充的周期
- `pipe_stall_cycle_dtlb_miss` (0x161): 数据TLB缺失导致的流水线停顿周期

#### 3.5.4 分支预测
- `mispredict_condition_br` (0x02): 条件分支预测错误
- `mispredict_take_condition_br` (0x12): 执行条件分支预测错误
- `mispredict_target_ret_inst` (0x22): 返回指令目标预测错误

### 3.6 mapfile.csv 修改

在mapfile.csv中添加了一行：
```
0x31e-0x8000000000008a45-0x[[:xdigit:]]+,v1,andes/ax45,core
```

这行配置的含义：
- `0x31e`: Andes的厂商ID
- `0x8000000000008a45`: AX45处理器的架构ID
- `0x[[:xdigit:]]+`: 实现ID的正则表达式匹配
- `v1`: JSON文件版本
- `andes/ax45`: 对应的JSON文件目录
- `core`: 事件类型为核心事件

## 4. 技术原理分析

### 4.1 PMU事件映射机制

perf工具通过以下步骤实现事件名称到硬件事件的映射：

1. **硬件识别**: 通过读取RISC-V的`mvendorid`、`marchid`和`mimpid`寄存器识别处理器
2. **映射文件查找**: 根据mapfile.csv中的正则表达式匹配找到对应的JSON文件目录
3. **事件解析**: 解析JSON文件中的事件定义，建立符号名称到EventCode的映射
4. **事件配置**: 将符号化的事件名称转换为硬件PMU寄存器配置

### 4.2 RISC-V PMU架构

RISC-V的PMU基于以下寄存器：
- `mcycle`: 机器模式周期计数器
- `minstret`: 机器模式指令退休计数器
- `mhpmcounter3-31`: 硬件性能监控计数器
- `mhpmevent3-31`: 硬件性能监控事件选择器

### 4.3 Andes AX45特性

Andes AX45是一个高性能的RISC-V处理器核心，具有以下特性：
- 支持RV64GC指令集
- 具有L1指令和数据缓存
- 支持虚拟内存管理（MMU）
- 具有分支预测器
- 支持原子操作和浮点运算

## 5. 相关提交分析

这个patch是Andes PMU支持系列patch的一部分，相关提交包括：

1. **bc969d6cc96a**: "perf: RISC-V: Introduce Andes PMU to support perf event sampling"
   - 引入了Andes PMU驱动的核心实现

2. **270fc77e7b0e**: "riscv: dts: renesas: Add Andes PMU extension for r9a07g043f"
   - 在设备树中添加了Andes PMU的描述

3. **61609bf2b29d**: "dt-bindings: riscv: Add Andes PMU extension description"
   - 添加了Andes PMU的设备树绑定文档

4. **ea0e0178e101**: "perf: RISC-V: Eliminate redundant interrupt enable/disable operations"
   - 优化了RISC-V PMU的中断处理

## 6. 影响和意义

### 6.1 用户体验改进

在这个patch之前，用户需要使用原始的事件代码：
```bash
perf stat -e r0x10,r0x20 ./program
```

应用patch后，用户可以使用符号化的事件名称：
```bash
perf stat -e cycle_count,inst_count ./program
```

### 6.2 性能分析能力增强

1. **更丰富的事件类型**: 提供了77个不同类型的性能事件
2. **更好的可读性**: 事件名称具有明确的语义
3. **更容易的脚本编写**: 可以使用有意义的事件名称编写性能分析脚本

### 6.3 生态系统完善

这个patch完善了RISC-V生态系统中的性能分析工具链，使得Andes AX45处理器能够与标准的Linux perf工具无缝集成。

## 7. 潜在问题和注意事项

### 7.1 硬件依赖性

这些事件定义是特定于Andes AX45处理器的，在其他RISC-V处理器上可能不可用或行为不同。

### 7.2 版本兼容性

需要确保JSON文件的版本与硬件实现保持同步，避免事件定义与实际硬件行为不匹配。

### 7.3 性能开销

使用大量的PMU事件可能会对系统性能产生影响，特别是在高频率采样的情况下。

## 8. 总结

这个patch通过添加JSON配置文件，为Andes AX45处理器提供了完整的PMU事件符号化支持。它不仅提升了用户体验，还为RISC-V生态系统的性能分析能力做出了重要贡献。这种设计模式也为其他RISC-V处理器厂商提供了很好的参考，有助于建立统一的性能分析工具生态。

通过这个patch，开发者可以更容易地进行性能分析和优化，从而推动RISC-V架构在高性能计算领域的应用和发展。