commit 87615e95f6f9ccd36d4a3905a2d87f91967ea9d2
Author: Nam Cao <namcaov@gmail.com>
Date:   Mon Aug 21 16:57:09 2023 +0200

    riscv: put interrupt entries into .irqentry.text

    The interrupt entries are expected to be in the .irqentry.text section.
    For example, for kprobes to work properly, exception code cannot be
    probed; this is ensured by blacklisting addresses in the .irqentry.text
    section.

    Fixes: 7db91e57a0ac ("RISC-V: Task implementation")
    Signed-off-by: Nam Cao <namcaov@gmail.com>
    Link: https://lore.kernel.org/r/20230821145708.21270-1-namcaov@gmail.com
    Cc: stable@vger.kernel.org
    Signed-off-by: Palmer Dabbelt <palmer@rivosinc.com>

diff --git a/arch/riscv/kernel/entry.S b/arch/riscv/kernel/entry.S
index 143a2bb3e697..d7dd9030df3f 100644
--- a/arch/riscv/kernel/entry.S
+++ b/arch/riscv/kernel/entry.S
@@ -14,6 +14,8 @@
 #include <asm/asm-offsets.h>
 #include <asm/errata_list.h>

+	.section .irqentry.text, "ax"
+
 SYM_CODE_START(handle_exception)
 	/*
 	 * If coming from userspace, preserve the user thread pointer and load


我需要查看commit 87615e95f6f9的详细信息，了解这个patch的内容和背景。

linux-stable
终端
git show 87615e95f6f9
现在我需要查看这个patch修复的原始commit 7db91e57a0ac，了解问题的根源。

linux-stable
终端
git show 7db91e57a0ac
我需要查看更多关于这个commit的信息，特别是它的完整内容和时间线。

linux-stable
终端
git log --oneline --grep="RISC-V: Task implementation" -n 5
让我查看entry.S文件的历史变化，了解.irqentry.text section的使用情况。

linux-stable
终端
git log --oneline arch/riscv/kernel/entry.S | head -10
让我查看kprobes相关的blacklist实现，了解.irqentry.text section的作用。

在工作区搜索 'kprobes blacklist irqentry.text section implementation in RISC-V'
让我查看kprobes相关的代码，了解.irqentry.text section是如何被使用的。

在工作区搜索 'kprobes blacklist implementation and irqentry text section usage'
让我查看vmlinux.lds.h文件，了解.irqentry.text section的定义。

在工作区搜索 'irqentry.text section definition in linker script'
让我查看vmlinux.lds.h文件，这是定义.irqentry.text section的关键文件。

include\asm-generic\vmlinux.lds.h
1-100
让我继续查看vmlinux.lds.h文件中关于.irqentry.text section的定义。

在工作区搜索 'irqentry\.text'
让我查看vmlinux.lds.h文件中IRQENTRY_TEXT的完整定义。

include\asm-generic\vmlinux.lds.h
595-620
现在让我查看RISC-V架构中如何使用IRQENTRY_TEXT，以及这个patch修复前后的差异。

linux-stable
终端
git log --oneline --grep="blacklist assembly symbols for kprobe" -n 3
让我查看这个blacklist assembly symbols的commit，了解它与87615e95f6f9的关系。

linux-stable
终端
git show ad39238d89e2
让我查看这两个commit的时间关系，了解它们的先后顺序。

linux-stable
终端
git log --oneline --since="2023-08-01" --until="2023-10-31" arch/riscv/kernel/entry.S
让我查看这两个commit的详细时间信息。

linux-stable
终端
git log --format="%H %ad %s" --date=short 87615e95f6f9 ad39238d89e2
让我直接查看这两个commit的具体日期。

linux-stable
终端
git show --format="%H %ad %s" --date=short --no-patch 87615e95f6f9
让我查看ad39238d89e2的日期。

linux-stable
终端
git show --format="%H %ad %s" --date=short --no-patch ad39238d89e2
现在让我查看RISC-V的vmlinux.lds.S文件，了解TEXT_SECTION的定义。

arch\riscv\kernel\vmlinux.lds.S
1-50
commit 87615e95f6f9 详细分析
基本信息
Commit ID: 87615e95f6f9ccd36d4a3905a2d87f91967ea9d2
作者: Nam Cao namcaov@gmail.com
日期: 2023年8月21日
标题: riscv: put interrupt entries into .irqentry.text
问题背景
这个patch解决的是一个关于kprobes功能的重要问题。在RISC-V架构中，中断处理入口函数（如handle_exception）原本没有被放置在正确的代码段中，这导致了kprobes无法正常工作。

技术细节
1. .irqentry.text段的作用
.irqentry.text是Linux内核中的一个特殊代码段，专门用于存放中断和异常处理的入口代码
这个段在链接脚本vmlinux.lds.h中定义：
PlainText



#define IRQENTRY_TEXT    ALIGN_FUNCTION();    __irqentry_text_start = .;    *(.irqentry.text)    __irqentry_text_end = .;
2. kprobes黑名单机制
kprobes是Linux内核的动态跟踪机制，但不能对某些关键代码进行探测
内核维护一个黑名单，禁止对中断处理代码进行kprobe
kprobes.c中的populate_kprobe_blacklist函数会将.irqentry.text段的所有代码加入黑名单
3. 修复内容
这个patch在entry.S文件开头添加了：

Assembly



.section .irqentry.text, "ax"
这确保了后续的中断处理函数（如handle_exception）被放置在正确的段中。

修复的问题
Fixes标签指向的原始问题
Fixes: 7db91e57a0ac ("RISC-V: Task implementation")
这个commit是2017年RISC-V架构最初加入Linux内核时的基础实现
当时没有正确处理中断入口代码的段分配问题
实际影响
1.
kprobes功能异常: 在修复前，可能会意外地对中断处理代码进行探测，导致系统不稳定
2.
安全性问题: 中断处理是内核最关键的部分，不应该被动态修改
3.
调试困难: 开发者无法依赖kprobes的正确行为进行内核调试
后续发展
在这个patch之后，还有一个相关的commit ad39238d89e2（2023年10月4日）：

标题: "riscv: blacklist assembly symbols for kprobe"
作用: 进一步完善了kprobes黑名单，通过ASM_NOKPROBE宏显式标记不能被探测的汇编函数
关系: 这是对87615e95f6f9的补充，提供了双重保护机制
技术意义
1.
架构完整性: 确保RISC-V架构与其他架构在kprobes处理上的一致性
2.
安全加固: 防止对关键中断处理代码的意外修改
3.
调试支持: 为内核开发者提供可靠的动态跟踪环境
总结
这个patch虽然只有简单的两行代码，但解决了一个从2017年RISC-V架构加入Linux内核以来就存在的基础性问题。它体现了内核开发中"细节决定成败"的重要性，一个看似微小的段分配问题，实际上影响了整个动态跟踪子系统的正确性和安全性。这也是为什么这个patch被标记为需要backport到stable分支的原因。