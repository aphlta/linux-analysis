# RISC-V Purgatory 4B 对齐修复 Patch 分析

## 基本信息

- **Commit ID**: 3f7023171df43641a8a8a1c9a12124501e589010
- **标题**: riscv/purgatory: 4B align purgatory_start
- **作者**: Björn Töpel <bjorn@rivosinc.com>
- **日期**: 2025年3月28日
- **修复的问题**: Fixes: 736e30af583fb ("RISC-V: Add purgatory")

## 问题描述

### 核心问题
当在RISC-V架构上启动crashkernel时，进入purgatory的过程是通过stvec CSR进行陷阱跳转实现的。但是purgatory_start函数没有正确的4字节对齐，导致crashkernel无法正常启动。

### 技术背景
1. **stvec CSR要求**: 根据RISC-V特权架构规范，stvec（Supervisor Trap Vector Base Address）寄存器要求地址必须4字节对齐
2. **kexec流程**: 在crashkernel启动过程中，`riscv_kexec_norelocate()`函数会执行以下关键操作：
   ```assembly
   csrw    CSR_STVEC, a2    // 设置陷阱向量地址
   csrw    CSR_SATP, zero   // 切换到物理地址模式，触发陷阱跳转
   ```

### 问题现象
在实际运行中观察到的问题：
```
Loaded purgatory at 0xffffc000
kexec_file: kexec_file_load: type:1, start:0xffffd232 head:0x4 flags:0x6
```

地址`0xffffd232`不是4字节对齐的（最后两位不是00），这违反了stvec的对齐要求。

## 代码修改分析

### 修改内容
在`arch/riscv/purgatory/entry.S`文件中，在`purgatory_start`函数定义前添加了对齐指令：

```assembly
.text

+.align 2              // 新增：4字节对齐指令
SYM_CODE_START(purgatory_start)
```

### 技术原理

1. **`.align 2`指令**: 在RISC-V汇编中，`.align 2`表示按2^2=4字节对齐
2. **对齐的必要性**: 
   - stvec CSR的硬件要求：地址的最低2位必须为0
   - 确保陷阱向量地址符合RISC-V架构规范
   - 保证crashkernel能够正确进入purgatory代码

## 相关代码流程分析

### Kexec执行流程

1. **正常kexec**: 使用`riscv_kexec_relocate`函数进行内核重定位
2. **Crashkernel**: 使用`riscv_kexec_norelocate`函数直接跳转

### 关键函数调用链

```
machine_kexec() 
  └── riscv_kexec_norelocate()  // 对于crashkernel
      ├── csrw CSR_STVEC, a2    // 设置陷阱向量为purgatory_start
      └── csrw CSR_SATP, zero   // 触发陷阱，跳转到purgatory
```

### Purgatory的作用

Purgatory是运行在两个内核之间的中间代码，主要功能：
1. **完整性验证**: 通过SHA256校验确保新内核镜像未被篡改
2. **参数传递**: 将hartid和FDT地址传递给新内核
3. **环境清理**: 清理寄存器状态
4. **内核启动**: 跳转到新内核入口点

## 影响分析

### 修复前的问题
- crashkernel无法正常启动
- 可能导致系统崩溃时无法生成crash dump
- kexec-file加载的crashkernel无法进入purgatory

### 修复后的改进
- 确保purgatory_start地址4字节对齐
- crashkernel可以正确进入purgatory代码
- 提高了系统崩溃后的可恢复性

## 相关提交历史

### 原始提交 (736e30af583fb)
该提交首次为RISC-V架构添加了purgatory支持，包括：
- `arch/riscv/purgatory/entry.S`: purgatory入口点
- `arch/riscv/purgatory/purgatory.c`: SHA256验证逻辑
- 支持kexec-file系统调用

### 本次修复的必要性
原始实现忽略了RISC-V架构对stvec CSR的对齐要求，导致在实际使用中出现问题。

## 架构特定考虑

### RISC-V特权架构要求
- **stvec对齐**: 必须4字节对齐（MODE字段占用最低2位）
- **陷阱处理**: 当SATP切换到Bare模式时，会触发陷阱跳转到stvec指定的地址
- **物理地址模式**: crashkernel运行在物理地址空间

### 与其他架构的差异
- x86架构使用不同的机制进入purgatory
- ARM64也有类似的对齐要求但具体实现不同
- RISC-V的stvec机制是其特有的设计

## 测试和验证

### 验证方法
1. **地址检查**: 确保purgatory_start地址的最低2位为0
2. **功能测试**: 验证crashkernel能够正常启动
3. **完整性测试**: 确保crash dump功能正常工作

### 预期结果
修复后，crashkernel加载时应该看到类似以下的对齐地址：
```
Loaded purgatory at 0xffffc000
kexec_file: kexec_file_load: type:1, start:0xffffd230 head:0x4 flags:0x6
```

## 总结

这是一个关键的架构特定修复，解决了RISC-V平台上crashkernel无法正常工作的问题。通过简单的对齐指令添加，确保了purgatory入口点符合RISC-V架构的硬件要求，提高了系统的可靠性和可调试性。这个修复对于生产环境中的RISC-V系统特别重要，因为它直接影响到系统崩溃后的恢复能力。