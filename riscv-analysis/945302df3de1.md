# RISC-V Zkr扩展KASLR种子支持分析 - Commit 945302df3de1

## 1. Patch基本信息

**Commit ID:** 945302df3de156fc367d3b537cec76d4aea0b0d1  
**作者:** Jesse Taube <jesse@rivosinc.com>  
**提交日期:** 2024年7月9日  
**标题:** RISC-V: Use Zkr to seed KASLR base address  
**邮件列表链接:** https://lore.kernel.org/r/20240709173937.510084-5-jesse@rivosinc.com  

## 2. Patch修改内容概述

这个patch为RISC-V架构添加了使用Zkr扩展来为KASLR（Kernel Address Space Layout Randomization）提供随机种子的功能。

### 2.1 修改的文件统计

- `arch/riscv/kernel/pi/Makefile` (3行修改)
- `arch/riscv/kernel/pi/archrandom_early.c` (30行新增)
- `arch/riscv/kernel/pi/fdt_early.c` (160行新增)
- `arch/riscv/kernel/pi/pi.h` (3行新增)
- `arch/riscv/mm/init.c` (5行修改)

总计：199行新增，2行删除

### 2.2 核心修改内容

#### 2.2.1 新增archrandom_early.c文件

```c
// SPDX-License-Identifier: GPL-2.0-only

#include <asm/csr.h>
#include <linux/processor.h>

#include "pi.h"

/*
 * To avoid rewriting code include asm/archrandom.h and create macros
 * for the functions that won't be included.
 */
#undef riscv_has_extension_unlikely
#define riscv_has_extension_likely(...) false
#undef pr_err_once
#define pr_err_once(...)

#include <asm/archrandom.h>

u64 get_kaslr_seed_zkr(const uintptr_t dtb_pa)
{
        unsigned long seed = 0;

        if (!fdt_early_match_extension_isa((const void *)dtb_pa, "zkr"))
                return 0;

        if (!csr_seed_long(&seed))
                return 0;

        return seed;
}
```

#### 2.2.2 fdt_early.c中新增ISA扩展检测函数

新增了三个关键函数：
- `isa_string_contains()` - 检查ISA字符串是否包含指定扩展
- `early_cpu_isa_ext_available()` - 检查单个CPU节点是否支持扩展
- `fdt_early_match_extension_isa()` - 检查所有可用CPU是否都支持扩展

#### 2.2.3 KASLR初始化逻辑修改

在`arch/riscv/mm/init.c`的`setup_vm()`函数中：

```c
#ifdef CONFIG_RANDOMIZE_BASE
       if (!__pi_set_nokaslr_from_cmdline(dtb_pa)) {
-               u64 kaslr_seed = __pi_get_kaslr_seed(dtb_pa);
+               u64 kaslr_seed = __pi_get_kaslr_seed_zkr(dtb_pa);
                u32 kernel_size = (uintptr_t)(&_end) - (uintptr_t)(&_start);
                u32 nr_pos;

+               if (kaslr_seed == 0)
+                       kaslr_seed = __pi_get_kaslr_seed(dtb_pa);
```

## 3. 技术原理分析

### 3.1 Zkr扩展简介

Zkr（Entropy Source）是RISC-V的标准加密扩展之一，提供硬件随机数生成功能：

- **指令支持**: 提供`seed`指令用于获取熵值
- **硬件实现**: 基于真随机数生成器(TRNG)
- **安全性**: 提供密码学安全的随机数
- **性能**: 比软件伪随机数生成器更高效

### 3.2 KASLR种子生成策略

#### 3.2.1 优先级机制

1. **首选Zkr扩展**: 如果硬件支持Zkr，优先使用硬件随机数
2. **回退机制**: 如果Zkr不可用或返回0，回退到传统的设备树种子方法
3. **兼容性**: 保持与现有KASLR实现的完全兼容

#### 3.2.2 实现流程

```
1. 检查设备树中所有CPU是否支持Zkr扩展
   ↓
2. 如果支持，执行seed指令获取随机数
   ↓
3. 如果获取成功，使用该值作为KASLR种子
   ↓
4. 如果失败或不支持，回退到传统方法
```

### 3.3 设备树ISA扩展检测

#### 3.3.1 ISA字符串解析

```c
static bool isa_string_contains(const char *isa_str, const char *ext_name)
{
        const char *ext_end;
        size_t ext_len = strlen(ext_name);

        while (*isa_str) {
                if (*isa_str == '_') {
                        isa_str++;
                        if (strncmp(isa_str, ext_name, ext_len) == 0) {
                                ext_end = isa_str + ext_len;
                                if (*ext_end == '\0' || *ext_end == '_')
                                        return true;
                        }
                }
                isa_str = strchr(isa_str, '_');
                if (isa_str)
                        isa_str++;
        }
        return false;
}
```

**解析逻辑:**
- 支持两种格式：`riscv,isa-extensions`属性和`riscv,isa`字符串
- ISA字符串格式：`rv64imafdc_zkr_zkt`
- 扩展名以下划线分隔
- 精确匹配扩展名，避免部分匹配错误

#### 3.3.2 全CPU检查机制

```c
bool fdt_early_match_extension_isa(const void *fdt, const char *ext_name)
{
        int node, parent;
        bool ret = false;

        parent = fdt_path_offset(fdt, "/cpus");
        if (parent < 0)
                return false;

        fdt_for_each_subnode(node, fdt, parent) {
                if (!fdt_node_name_eq(fdt, node, "cpu"))
                        continue;

                if (!fdt_device_is_available(fdt, node))
                        continue;

                if (!early_cpu_isa_ext_available(fdt, node, ext_name))
                        return false;

                ret = true;
        }

        return ret;
}
```

**检查策略:**
- 遍历所有CPU节点
- 只检查可用的CPU（`status = "okay"`）
- 要求所有可用CPU都支持该扩展
- 如果任何一个CPU不支持，返回false

### 3.4 Position-Independent代码集成

#### 3.4.1 PI代码特点

- **早期执行**: 在MMU启用之前运行
- **地址无关**: 可以在任意物理地址执行
- **符号前缀**: 所有符号添加`__pi_`前缀
- **独立编译**: 使用特殊的编译选项

#### 3.4.2 编译集成

在`arch/riscv/kernel/pi/Makefile`中：

```makefile
CFLAGS_archrandom_early.o += -D__NO_FORTIFY

obj-y := cmdline_early.pi.o fdt_early.pi.o string.pi.o ctype.pi.o \
         lib-fdt.pi.o lib-fdt_ro.pi.o archrandom_early.pi.o
```

## 4. 安全性考虑

### 4.1 硬件信任模型

- **固件依赖**: 必须信任固件正确实现Zkr扩展
- **硬件质量**: 依赖硬件随机数生成器的质量
- **侧信道攻击**: 硬件实现需要抵御侧信道攻击

### 4.2 ACPI系统限制

根据commit message：
> On an ACPI system, as of this commit, there is no easy way to check if
> Zkr is present. Blindly running the instruction isn't an option as;
> we have to be able to trust the firmware.

**限制说明:**
- ACPI系统缺乏标准的ISA扩展检测机制
- 不能盲目执行seed指令，可能导致非法指令异常
- 需要可信的固件环境

### 4.3 回退机制安全性

- **渐进降级**: 从硬件随机数降级到设备树种子
- **兼容性保证**: 不会因为Zkr不可用而影响KASLR功能
- **零值处理**: 正确处理seed指令返回0的情况

## 5. 性能影响分析

### 5.1 启动时间影响

- **设备树解析**: 增加了ISA扩展检测的开销
- **硬件指令**: seed指令执行时间通常很短
- **总体影响**: 对启动时间的影响微乎其微

### 5.2 内存占用

- **代码大小**: 新增约200行代码
- **PI段影响**: 增加了PI段的大小
- **运行时**: 不影响运行时内存使用

## 6. 相关提交分析

这个patch是一个系列提交的一部分，旨在改进RISC-V的PI代码基础设施：

### 6.1 前置提交

1. **14c3ec67236b** - "RISC-V: pi: Force hidden visibility for all symbol references"
   - 消除PI段中的GOT条目
   - 强制隐藏符号可见性
   - 为后续优化奠定基础

2. **d57e19fcbf3f** - "RISC-V: lib: Add pi aliases for string functions"
   - 为字符串函数添加PI别名
   - 支持memset、strcmp、strncmp
   - 解决KASAN启用时的符号依赖

3. **b3311827155a** - "RISC-V: pi: Add kernel/pi/pi.h"
   - 创建统一的PI头文件
   - 集中管理PI函数声明
   - 解决LLVM编译器警告

### 6.2 提交关系

```
14c3ec67236b (PI符号可见性)
       ↓
d57e19fcbf3f (字符串函数别名)
       ↓
b3311827155a (统一头文件)
       ↓
945302df3de1 (Zkr KASLR支持) ← 当前分析的提交
```

## 7. 测试和验证

### 7.1 测试覆盖

- **测试者**: Zong Li <zong.li@sifive.com>
- **审查者**: 
  - Charlie Jenkins <charlie@rivosinc.com>
  - Alexandre Ghiti <alexghiti@rivosinc.com>
  - Conor Dooley <conor.dooley@microchip.com>

### 7.2 验证场景

1. **Zkr支持的硬件**: 验证硬件随机数生成
2. **不支持Zkr的硬件**: 验证回退机制
3. **ACPI系统**: 确认不会误用Zkr
4. **设备树格式**: 测试不同的ISA字符串格式

## 8. 未来发展方向

### 8.1 ACPI支持

- 需要ACPI规范定义ISA扩展检测机制
- 可能通过ACPI表或UEFI变量传递信息
- 需要与ACPI工作组协调

### 8.2 其他加密扩展

- **Zkt**: 数据无关时间扩展
- **Zkn**: 对称加密扩展
- **Zks**: SM4加密扩展

### 8.3 性能优化

- 缓存ISA扩展检测结果
- 优化设备树解析性能
- 减少PI代码段大小

## 9. 总结

这个patch成功地为RISC-V架构添加了基于Zkr扩展的KASLR种子生成功能，具有以下特点：

### 9.1 技术优势

1. **硬件加速**: 利用专用硬件提供高质量随机数
2. **向后兼容**: 完全兼容现有KASLR实现
3. **渐进增强**: 在支持的硬件上提供更好的安全性
4. **代码质量**: 遵循RISC-V内核开发最佳实践

### 9.2 安全改进

1. **熵质量**: 硬件随机数比伪随机数具有更好的熵特性
2. **攻击抵抗**: 减少了基于软件随机数生成器的攻击面
3. **不可预测性**: 提高了KASLR地址的不可预测性

### 9.3 实现质量

1. **错误处理**: 完善的错误处理和回退机制
2. **代码复用**: 充分利用现有的PI基础设施
3. **测试覆盖**: 经过充分的测试和审查
4. **文档完整**: 清晰的代码注释和commit message

这个patch为RISC-V生态系统的安全性做出了重要贡献，展示了如何正确地集成新的硬件特性来增强内核安全性。