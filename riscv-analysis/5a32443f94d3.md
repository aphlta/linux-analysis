# RISC-V页表分配优化补丁分析

## 基本信息

**Commit ID:** 5a32443f94d3
**作者:** Kevin Brodsky <kevin.brodsky@arm.com>
**提交日期:** 2025年1月8日
**标题:** riscv: mm: skip pgtable level check in {pud,p4d}_alloc_one

## 补丁系列背景

这个补丁是一个16个补丁系列的第1个，该系列的目标是将`pagetable_*_dtor()`函数移动到`__tlb_remove_table()`中。这个系列旨在：

1. 清理`pagetable_*_dtor()`代码
2. 更优雅地修复syzbot报告的UAF（Use After Free）问题
3. 统一不同架构的页表处理方式

## 修改内容详细分析

### 删除的代码

1. **移除`__HAVE_ARCH_PUD_ALLOC_ONE`宏定义**
   ```c
   -#define __HAVE_ARCH_PUD_ALLOC_ONE
   ```

2. **删除自定义的`pud_alloc_one`函数**
   ```c
   -#define pud_alloc_one pud_alloc_one
   -static inline pud_t *pud_alloc_one(struct mm_struct *mm, unsigned long addr)
   -{
   -       if (pgtable_l4_enabled)
   -               return __pud_alloc_one(mm, addr);
   -
   -       return NULL;
   -}
   ```

3. **简化`p4d_alloc_one`函数**
   - **修改前:**
   ```c
   static inline p4d_t *p4d_alloc_one(struct mm_struct *mm, unsigned long addr)
   {
           if (pgtable_l5_enabled) {
                   gfp_t gfp = GFP_PGTABLE_USER;

                   if (mm == &init_mm)
                           gfp = GFP_PGTABLE_KERNEL;
                   return (p4d_t *)get_zeroed_page(gfp);
           }

           return NULL;
   }
   ```

   - **修改后:**
   ```c
   static inline p4d_t *p4d_alloc_one(struct mm_struct *mm, unsigned long addr)
   {
           gfp_t gfp = GFP_PGTABLE_USER;

           if (mm == &init_mm)
                   gfp = GFP_PGTABLE_KERNEL;
           return (p4d_t *)get_zeroed_page(gfp);
   }
   ```

## 修改原理分析

### 1. 页表级别检查的冗余性

在Linux内核的页表管理中，`{pmd,pud,p4d}_alloc_one()`函数只有在对应的页表级别没有被折叠时才会被调用。这是因为上层的`{pmd,pud,p4d}_alloc()`函数已经进行了必要的检查。

### 2. 通用实现的等价性

删除RISC-V特定的`pud_alloc_one`实现后，内核将使用通用的实现（在`include/asm-generic/pgalloc.h`中定义）：

```c
static inline pud_t *__pud_alloc_one_noprof(struct mm_struct *mm, unsigned long addr)
{
        gfp_t gfp = GFP_PGTABLE_USER;
        struct ptdesc *ptdesc;

        if (mm == &init_mm)
                gfp = GFP_PGTABLE_KERNEL;
        gfp &= ~__GFP_HIGHMEM;

        ptdesc = pagetable_alloc_noprof(gfp, 0);
        if (!ptdesc)
                return NULL;

        pagetable_pud_ctor(ptdesc);
        return ptdesc_address(ptdesc);
}
```

这个通用实现提供了与RISC-V特定实现相同的功能，但增加了适当的构造函数调用。

### 3. 架构一致性

这个修改使RISC-V与arm64和x86架构保持一致，这些架构只在`p4d_free()`中进行运行时检查，而不在分配函数中进行检查。

## 技术影响

### 1. 性能影响
- **正面影响:** 移除了不必要的运行时检查，减少了代码路径
- **中性影响:** 使用通用实现可能略微增加函数调用开销，但这在页表分配的上下文中是微不足道的

### 2. 代码维护性
- **简化代码:** 减少了架构特定的代码量
- **提高一致性:** 与其他架构的实现方式保持一致
- **降低维护负担:** 使用通用实现减少了重复代码

### 3. 功能正确性
- **保持功能等价:** 修改后的行为与修改前完全相同
- **增强健壮性:** 通用实现包含了更完整的错误处理和构造函数调用

## 相关提交分析

这个补丁是一个更大重构系列的一部分，相关的后续提交包括：

1. `db6b435d731a` - mm: pgtable: introduce pagetable_dtor()
2. `12359c039b5f` - arm64: pgtable: move pagetable_dtor() to __tlb_remove_table()
3. `deab5a355e52` - riscv: pgtable: move pagetable_dtor() to __tlb_remove_table()
4. `92ec7fd136a1` - mm: pgtable: completely move pagetable_dtor() to generic tlb_remove_table()

这些提交共同实现了将页表析构函数统一移动到通用TLB移除路径的目标。

## 总结

这个补丁是一个代码清理和优化的典型例子，它：

1. **移除了冗余的运行时检查**，因为这些检查在调用路径的更高层已经完成
2. **简化了架构特定代码**，转而使用经过良好测试的通用实现
3. **提高了代码一致性**，使RISC-V与其他主要架构保持一致
4. **为后续的重构工作奠定基础**，使得将析构函数移动到通用路径成为可能

这种类型的重构对于内核的长期维护和稳定性非常重要，它减少了代码重复，提高了代码质量，并为未来的优化创造了条件。