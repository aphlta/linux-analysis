# RISC-V内存大小限制移除补丁分析

## 1. 补丁基本信息

**Commit ID**: d6a1928134a1c626ff369129d7a80951b2949a48  
**作者**: Stuart Menefy <stuart.menefy@codasip.com>  
**日期**: 2024年6月24日  
**标题**: riscv: Remove redundant restriction on memory size  
**审核者**: Alexandre Ghiti <alexghiti@rivosinc.com>  
**合并者**: Palmer Dabbelt <palmer@rivosinc.com>  

## 2. 补丁内容分析

### 2.1 修改概述

这个补丁移除了RISC-V架构中对内存大小的冗余限制。具体来说，它移除了为模块/BPF/内核映射预留直接映射顶部4GiB空间的限制。

### 2.2 代码变更详情

**文件**: `arch/riscv/mm/init.c`

**修改前**:
```c
/*
 * The default maximal physical memory size is KERN_VIRT_SIZE for 32-bit
 * kernel, whereas for 64-bit kernel, the end of the virtual address
 * space is occupied by the modules/BPF/kernel mappings which reduces
 * the available size of the linear mapping.
 */
memory_limit = KERN_VIRT_SIZE - (IS_ENABLED(CONFIG_64BIT) ? SZ_4G : 0);
```

**修改后**:
```c
memory_limit = KERN_VIRT_SIZE;
```

### 2.3 技术背景

#### 2.3.1 KERN_VIRT_SIZE定义

根据`arch/riscv/include/asm/pgtable.h`中的定义：

```c
/*
 * Half of the kernel address space (1/4 of the entries of the page global
 * directory) is for the direct mapping.
 */
#define KERN_VIRT_SIZE          ((PTRS_PER_PGD / 2 * PGDIR_SIZE) / 2)
```

这意味着内核虚拟地址空间的一半（页全局目录条目的1/4）用于直接映射。

#### 2.3.2 历史原因

原始的4GiB限制是为了在直接映射的顶部为以下组件预留空间：
- 模块(Modules)
- BPF程序
- 内核映射

这种设计在早期的RISC-V内存布局中是必要的，因为这些组件需要在虚拟地址空间的特定区域。

## 3. KASAN地址映射重构的影响

### 3.1 地址映射重构

这个限制移除的关键原因是RISC-V的地址映射在KASAN（Kernel Address Sanitizer）支持过程中进行了重构。相关的重要提交包括：

- **2667e3673f70**: "RISC-V kasan rework" 合并补丁系列
- **add2cc6b6515**: "RISC-V: mm: Restrict address space for sv39,sv48,sv57"
- **401e84488800**: "riscv: Move DTB_EARLY_BASE_VA to the kernel address space"

### 3.2 新的内存布局

在KASAN重构后，RISC-V采用了新的内存布局策略：

1. **64位系统**:
   - 内核链接地址: `ADDRESS_SPACE_END - SZ_2G + 1`
   - 模块地址: `KERNEL_LINK_ADDR - SZ_2G` 到 `PFN_ALIGN((unsigned long)&_start)`

2. **虚拟地址空间分配**:
   - VMALLOC区域: `KERN_VIRT_SIZE >> 1`
   - BPF JIT区域: 128MB
   - 模块区域: 在内核之前的2GB空间

### 3.3 地址空间优化

新的布局提供了更好的地址空间利用率：

```c
#define VMALLOC_SIZE     (KERN_VIRT_SIZE >> 1)
#define VMALLOC_END      PAGE_OFFSET
#define VMALLOC_START    (PAGE_OFFSET - VMALLOC_SIZE)

#define BPF_JIT_REGION_SIZE	(SZ_128M)
#ifdef CONFIG_64BIT
#define BPF_JIT_REGION_START	(BPF_JIT_REGION_END - BPF_JIT_REGION_SIZE)
#define BPF_JIT_REGION_END	(MODULES_END)
#endif
```

## 4. 技术原理分析

### 4.1 直接映射的作用

直接映射（Direct Mapping）是内核虚拟地址空间中的一个区域，它提供了物理内存到虚拟地址的线性映射。这种映射的优势包括：

1. **性能优化**: 避免了页表查找的开销
2. **简化内存管理**: 物理地址和虚拟地址之间有固定的偏移关系
3. **内核数据结构访问**: 内核可以直接访问物理内存中的数据结构

### 4.2 为什么可以移除4GiB限制

1. **地址空间重新设计**: KASAN重构后，模块、BPF和内核映射不再占用直接映射区域的顶部空间
2. **更好的空间分离**: 新的布局将不同类型的映射分离到不同的虚拟地址区域
3. **KASAN兼容性**: 新布局确保KASAN可以正确地监控所有内存访问

### 4.3 内存限制计算

**修改前的计算**:
```c
// 32位: memory_limit = KERN_VIRT_SIZE
// 64位: memory_limit = KERN_VIRT_SIZE - 4GB
```

**修改后的计算**:
```c
// 32位和64位: memory_limit = KERN_VIRT_SIZE
```

这意味着64位系统现在可以使用额外的4GiB直接映射空间。

## 5. 影响和好处

### 5.1 内存利用率提升

- **64位系统**: 可以使用额外的4GiB物理内存进行直接映射
- **更大的系统支持**: 支持更大的物理内存配置
- **减少内存碎片**: 更连续的直接映射区域

### 5.2 性能改进

1. **减少TLB压力**: 更大的直接映射区域意味着更少的页表查找
2. **改进缓存局部性**: 连续的内存布局有助于缓存性能
3. **简化内存分配**: 内核内存分配器有更多的直接映射空间可用

### 5.3 系统兼容性

- **向后兼容**: 不影响现有的32位系统
- **KASAN兼容**: 与KASAN内存检测工具完全兼容
- **模块加载**: 不影响内核模块的加载和执行

## 6. 相关提交分析

### 6.1 KASAN重构系列

这个补丁是RISC-V KASAN支持重构的后续优化，相关的关键提交包括：

1. **cd0334e1c091**: "riscv: Split early and final KASAN population functions"
2. **401e84488800**: "riscv: Move DTB_EARLY_BASE_VA to the kernel address space"
3. **617955ca6e27**: "riscv: Fix EFI stub usage of KASAN instrumented strcmp function"
4. **ecd7ebaf0b5a**: "riscv: Fix ptdump when KASAN is enabled"
5. **864046c512c2**: "riscv: Unconditionnally select KASAN_VMALLOC if KASAN"

### 6.2 地址空间限制重构

**add2cc6b6515**: "RISC-V: mm: Restrict address space for sv39,sv48,sv57" 这个提交重新定义了不同页表级别的地址空间限制，为当前补丁奠定了基础。

## 7. 测试和验证

### 7.1 兼容性测试

根据相关提交信息，这些更改经过了广泛的测试：

- **多种配置测试**: inline/outline ubuntu配置 + UEFI
- **多种页表级别**: sv39、sv48、sv57
- **KASAN功能测试**: KASAN_KUNIT_TEST和KASAN_MODULE_TEST

### 7.2 性能验证

虽然补丁本身没有提供性能数据，但理论上应该带来以下改进：

1. **内存分配性能**: 更大的直接映射区域
2. **TLB效率**: 减少页表查找次数
3. **系统吞吐量**: 支持更大的内存配置

## 8. 总结

这个补丁是RISC-V内存管理子系统演进的重要一步。通过移除冗余的4GiB内存限制，它：

1. **提升了内存利用率**: 64位系统可以使用更多的物理内存
2. **简化了代码**: 移除了不再需要的条件判断
3. **改进了性能**: 更大的直接映射区域带来性能优势
4. **保持了兼容性**: 不影响现有系统的正常运行

这个变更反映了RISC-V架构在内存管理方面的成熟，以及对现代大内存系统需求的响应。它是KASAN支持重构工作的自然延续，展示了内核开发中持续优化和简化的重要性。