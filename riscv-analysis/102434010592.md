# RISC-V Zkr扩展archrandom实现分析

## Commit信息

**Commit ID**: 102434010592 (10243401059287868a5651f869a2494368872add)  
**标题**: RISC-V: Implement archrandom when Zkr is available  
**作者**: Samuel Ortiz <sameo@rivosinc.com>  
**提交者**: Palmer Dabbelt <palmer@rivosinc.com>  
**日期**: 2023年11月30日  
**链接**: https://lore.kernel.org/r/20231130111704.1319081-1-cleger@rivosinc.com  

## Patch概述

这个patch为RISC-V架构实现了基于Zkr扩展的硬件随机数生成器支持，通过读取SEED CSR寄存器来获取熵源，并实现了Linux内核的archrandom接口。

## 修改文件分析

### 1. arch/riscv/include/asm/archrandom.h (新增文件)

**文件作用**: 定义RISC-V架构的硬件随机数生成接口

**主要内容**:

#### 1.1 CSR读取函数
```c
static inline bool csr_seed_long(unsigned long *v)
{
    unsigned int retry = SEED_RETRY_COUNT, valid_seeds = 0;
    const unsigned int needed_seeds = sizeof(unsigned long) / sizeof(u16);
    u32 csr_seed, entropy[needed_seeds];
    unsigned long opst;

    do {
        csr_seed = csr_read(CSR_SEED);
        opst = csr_seed & SEED_OPST_MASK;

        switch (opst) {
        case SEED_OPST_ES16:
            entropy[valid_seeds++] = csr_seed & SEED_ENTROPY_MASK;
            if (valid_seeds == needed_seeds)
                return true;
            break;

        case SEED_OPST_DEAD:
            pr_err_once("archrandom: Unrecoverable error\n");
            return false;

        case SEED_OPST_BIST:
        case SEED_OPST_WAIT:
        default:
            cpu_relax();
            continue;
        }
    } while (--retry);

    return false;
}
```

**技术原理**:
- 通过多次读取SEED CSR获取16位熵值
- 根据操作状态(OPST)字段判断读取结果
- 累积足够的熵值组成一个unsigned long
- 实现重试机制处理WAIT和BIST状态

#### 1.2 内核接口实现
```c
static inline size_t __must_check arch_get_random_seed_longs(unsigned long *v, size_t max_longs)
{
    if (!max_longs)
        return 0;

    if (riscv_has_extension_likely(RISCV_ISA_EXT_ZKR) && csr_seed_long(v))
        return 1;

    return 0;
}
```

**设计特点**:
- 检查Zkr扩展是否可用
- 每次调用最多返回一个long值的熵
- 失败时返回0，成功时返回1

### 2. arch/riscv/include/asm/csr.h (修改)

**新增内容**: Zkr扩展相关的CSR定义

```c
/* Scalar Crypto Extension - Entropy */
#define CSR_SEED               0x015
#define SEED_OPST_MASK         _AC(0xC0000000, UL)
#define SEED_OPST_BIST         _AC(0x00000000, UL)
#define SEED_OPST_WAIT         _AC(0x40000000, UL)
#define SEED_OPST_ES16         _AC(0x80000000, UL)
#define SEED_OPST_DEAD         _AC(0xC0000000, UL)
#define SEED_ENTROPY_MASK      _AC(0xFFFF, UL)
```

**字段含义**:
- `CSR_SEED`: SEED CSR寄存器地址(0x015)
- `SEED_OPST_*`: 操作状态字段定义
  - `BIST`: 内建自测试状态
  - `WAIT`: 等待状态，熵源暂时不可用
  - `ES16`: 有效状态，提供16位熵值
  - `DEAD`: 错误状态，熵源不可恢复
- `SEED_ENTROPY_MASK`: 熵值掩码(低16位)

## Zkr扩展技术原理

### 1. 扩展定义

**Zkr (Entropy Source Extension)**:
- **标准化状态**: RISC-V标量密码学扩展的一部分，已正式批准
- **用途**: 提供硬件熵源，用于密码学随机数生成
- **CSR接口**: 通过SEED CSR(0x015)提供16位熵值

### 2. SEED CSR寄存器格式

```
31    30    29-16    15-0
|OPST[1]|OPST[0]| Reserved | ENTROPY |
```

**字段说明**:
- `OPST[1:0]`: 操作状态(2位)
  - `00`: BIST - 内建自测试运行中
  - `01`: WAIT - 等待状态，暂时无熵可用
  - `10`: ES16 - 有效状态，ENTROPY字段包含16位熵
  - `11`: DEAD - 错误状态，熵源故障
- `ENTROPY[15:0]`: 16位熵值(仅在ES16状态有效)

### 3. 熵获取流程

1. **读取SEED CSR**: 执行`csrr`指令读取CSR_SEED
2. **检查状态**: 提取OPST字段判断当前状态
3. **处理状态**:
   - `ES16`: 提取16位熵值，累积到目标缓冲区
   - `WAIT/BIST`: 调用`cpu_relax()`等待，然后重试
   - `DEAD`: 报告错误并退出
4. **重试机制**: 最多重试SEED_RETRY_COUNT次
5. **熵组装**: 将多个16位熵值组合成完整的unsigned long

### 4. 安全特性

**硬件保证**:
- 熵源符合NIST SP 800-90B标准
- 硬件实现包含健康检查机制
- 提供真随机数，不是伪随机数

**软件保护**:
- 状态检查确保只使用有效熵值
- 错误处理机制防止使用损坏的熵源
- 重试机制处理临时不可用状态

## 内核集成分析

### 1. archrandom框架

这个patch实现了Linux内核的archrandom接口，该接口用于:
- 为内核随机数生成器提供硬件熵源
- 支持`/dev/random`和`/dev/urandom`设备
- 提供高质量的密码学随机数

### 2. 接口函数

```c
// 获取种子熵(高质量)
size_t arch_get_random_seed_longs(unsigned long *v, size_t max_longs)

// 获取普通随机数(未实现，返回0)
size_t arch_get_random_longs(unsigned long *v, size_t max_longs)
```

### 3. 扩展检测

通过`riscv_has_extension_likely(RISCV_ISA_EXT_ZKR)`检测Zkr扩展可用性:
- 在`arch/riscv/include/asm/hwcap.h`中定义`RISCV_ISA_EXT_ZKR = 52`
- 在`arch/riscv/kernel/cpufeature.c`中注册为"zkr"扩展
- 运行时动态检测硬件支持

## 性能和效率分析

### 1. 性能特点

**优势**:
- 硬件实现，性能优于软件PRNG
- 直接CSR访问，延迟低
- 无需外部设备或中断

**限制**:
- 每次读取仅16位熵值
- 需要多次读取组成完整的long值
- 可能遇到WAIT状态需要重试

### 2. 使用场景

**适用于**:
- 密码学密钥生成
- 安全随机数需求
- 系统熵池补充

**不适用于**:
- 高频率随机数生成
- 大量随机数据生成
- 实时性要求极高的场景

## 相关提交和发展

### 1. 依赖提交

这个patch依赖于以下基础设施:
- RISC-V ISA扩展检测框架
- CSR访问宏定义
- archrandom接口定义

### 2. 后续发展

可能的改进方向:
- 优化重试策略
- 添加性能计数器
- 支持批量熵获取
- 错误统计和监控

## 总结

这个patch为RISC-V架构添加了重要的硬件随机数生成能力，通过实现Zkr扩展支持，为Linux内核提供了高质量的硬件熵源。实现遵循了RISC-V标准规范，正确处理了各种硬件状态，并与Linux内核的archrandom框架良好集成。这为RISC-V平台的密码学应用和安全功能提供了重要的硬件基础。

**关键贡献**:
1. 实现了RISC-V Zkr扩展的软件支持
2. 为Linux内核提供了硬件熵源
3. 正确处理了硬件状态和错误情况
4. 遵循了内核编程规范和安全最佳实践

**技术意义**:
- 提升了RISC-V平台的安全能力
- 为密码学应用提供了硬件加速
- 完善了RISC-V生态系统的安全基础设施