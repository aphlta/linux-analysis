# RISC-V hwprobe: Add SCALAR to misaligned perf defines - Patch分析

## Commit信息
- **Commit ID**: 1f5288874de776412041022607513ffac74ae1a6
- **作者**: Evan Green <evan@rivosinc.com>
- **日期**: 2024年8月9日
- **标题**: RISC-V: hwprobe: Add SCALAR to misaligned perf defines

## Patch概述

这个patch是为了准备支持misaligned vector性能hwprobe keys而进行的重构工作。主要目的是将与misaligned scalar访问相关的hwprobe key值重命名，在名称中包含"SCALAR"术语，以便与即将到来的vector相关定义进行区分。同时保留旧的定义以维持源代码兼容性。

## 修改内容详细分析

### 1. 文档更新 (Documentation/arch/riscv/hwprobe.rst)

文档中的宏定义名称全部更新，添加了"SCALAR"标识：
- `RISCV_HWPROBE_MISALIGNED_UNKNOWN` → `RISCV_HWPROBE_MISALIGNED_SCALAR_UNKNOWN`
- `RISCV_HWPROBE_MISALIGNED_EMULATED` → `RISCV_HWPROBE_MISALIGNED_SCALAR_EMULATED`
- `RISCV_HWPROBE_MISALIGNED_SLOW` → `RISCV_HWPROBE_MISALIGNED_SCALAR_SLOW`
- `RISCV_HWPROBE_MISALIGNED_FAST` → `RISCV_HWPROBE_MISALIGNED_SCALAR_FAST`
- `RISCV_HWPROBE_MISALIGNED_UNSUPPORTED` → `RISCV_HWPROBE_MISALIGNED_SCALAR_UNSUPPORTED`

### 2. 头文件更新 (arch/riscv/include/uapi/asm/hwprobe.h)

在UAPI头文件中添加了新的宏定义，同时保留旧定义：

```c
// 新增的SCALAR相关定义
#define RISCV_HWPROBE_KEY_MISALIGNED_SCALAR_PERF	9
#define		RISCV_HWPROBE_MISALIGNED_SCALAR_UNKNOWN		0
#define		RISCV_HWPROBE_MISALIGNED_SCALAR_EMULATED	1
#define		RISCV_HWPROBE_MISALIGNED_SCALAR_SLOW		2
#define		RISCV_HWPROBE_MISALIGNED_SCALAR_FAST		3
#define		RISCV_HWPROBE_MISALIGNED_SCALAR_UNSUPPORTED	4

// 保留的旧定义（为了兼容性）
#define RISCV_HWPROBE_KEY_CPUPERF_0	5
#define		RISCV_HWPROBE_MISALIGNED_UNKNOWN	(0 << 0)
#define		RISCV_HWPROBE_MISALIGNED_EMULATED	(1 << 0)
#define		RISCV_HWPROBE_MISALIGNED_SLOW		(2 << 0)
#define		RISCV_HWPROBE_MISALIGNED_FAST		(3 << 0)
#define		RISCV_HWPROBE_MISALIGNED_UNSUPPORTED	(4 << 0)
```

### 3. 内核实现更新

#### sys_hwprobe.c
更新了hwprobe系统调用的实现，使用新的SCALAR定义：
- 在`hwprobe_misaligned_perf()`函数中使用新的宏定义
- 保持功能逻辑不变，仅更新宏名称

#### traps_misaligned.c
更新了misaligned访问陷阱处理代码：
- 将`RISCV_HWPROBE_MISALIGNED_EMULATED`替换为`RISCV_HWPROBE_MISALIGNED_SCALAR_EMULATED`

#### unaligned_access_speed.c
这是修改最多的文件，更新了所有相关的宏使用：
- `RISCV_HWPROBE_MISALIGNED_SLOW` → `RISCV_HWPROBE_MISALIGNED_SCALAR_SLOW`
- `RISCV_HWPROBE_MISALIGNED_UNKNOWN` → `RISCV_HWPROBE_MISALIGNED_SCALAR_UNKNOWN`
- `RISCV_HWPROBE_MISALIGNED_FAST` → `RISCV_HWPROBE_MISALIGNED_SCALAR_FAST`

## 技术原理分析

### 1. hwprobe机制

RISC-V的hwprobe是一个系统调用接口，允许用户空间程序查询硬件特性和性能特征。这个机制类似于x86的CPUID指令，但通过系统调用实现，提供了更灵活的查询方式。

### 2. Misaligned访问性能检测

RISC-V架构对于misaligned内存访问的处理方式因实现而异：
- **EMULATED**: 通过软件模拟实现，性能极差
- **SLOW**: 硬件支持但性能较差
- **FAST**: 硬件高效支持
- **UNSUPPORTED**: 不支持，会产生异常
- **UNKNOWN**: 性能特征未知

### 3. Scalar vs Vector区分的必要性

随着RISC-V Vector扩展的普及，需要区分scalar和vector的misaligned访问性能：
- Scalar访问：传统的标量数据访问
- Vector访问：向量指令的内存访问，可能有不同的性能特征

这种区分使得应用程序可以针对不同类型的访问做出优化决策。

## 相关提交分析

### 前置提交: c42e2f076769

这个patch是系列提交的第二部分，前一个提交`c42e2f076769`引入了`RISCV_HWPROBE_KEY_MISALIGNED_PERF`，修复了原有`RISCV_HWPROBE_KEY_CPUPERF_0`在与`RISCV_HWPROBE_WHICH_CPUS`标志一起使用时的问题。

**问题背景**：
- 原来的`CPUPERF_0`被错误地标记为bitmask，实际上应该是enum值
- 这导致在使用`WHICH_CPUS`标志查询时，SLOW、FAST、EMULATED的位会重叠
- 查询SLOW或EMULATED的CPU集合时，也会错误地包含FAST的CPU

**解决方案**：
- 引入新的`RISCV_HWPROBE_KEY_MISALIGNED_PERF` key
- 正确处理为枚举值而非位掩码
- 保留旧key以维持兼容性

### 后续发展

从头文件可以看到，已经预留了`RISCV_HWPROBE_KEY_MISALIGNED_VECTOR_PERF`（key 10），表明vector misaligned性能检测功能即将到来。

## 影响和意义

### 1. 向前兼容性

这个patch很好地处理了兼容性问题：
- 保留所有旧的宏定义
- 新代码使用新的SCALAR命名
- 现有应用程序无需修改即可继续工作

### 2. 为Vector扩展做准备

通过明确区分scalar和vector，为RISC-V Vector扩展的misaligned访问性能检测奠定了基础。这对于向量化代码的性能优化非常重要。

### 3. API设计改进

这个重构体现了良好的API设计原则：
- 明确的命名约定
- 渐进式演进
- 向后兼容性保证

## 总结

这个patch是一个典型的重构性改动，主要目的是为未来的功能扩展做准备。通过在misaligned性能相关的宏定义中添加"SCALAR"标识，为即将到来的vector misaligned性能检测功能预留了命名空间。

虽然这个改动在功能上是no-op（无操作），但它体现了内核开发中前瞻性设计的重要性。通过提前进行这种重构，避免了未来引入vector支持时可能出现的命名冲突和API混乱。

这种渐进式的API演进方式，既保证了现有代码的兼容性，又为新功能的引入提供了清晰的路径，是内核开发中值得学习的最佳实践。