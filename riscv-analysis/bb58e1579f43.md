# Patch Analysis: bb58e1579f43

## 基本信息

**Commit ID:** bb58e1579f43  
**作者:** Palmer Dabbelt <palmer@rivosinc.com>  
**日期:** Wed Mar 26 15:45:07 2025 -0700  
**标题:** RISC-V: errata: Use medany for relocatable builds  

## 问题描述

这个patch解决了在RISC-V架构中，当启用CONFIG_RELOCATABLE配置时，errata处理代码在链接阶段出现的重定位错误问题。

### 具体错误信息

```
riscv64-unknown-linux-gnu-ld: arch/riscv/errata/sifive/errata.o: relocation R_RISCV_HI20 against `tlb_flush_all_threshold' can not be used when making a shared object; recompile with -fPIC
riscv64-unknown-linux-gnu-ld: arch/riscv/errata/thead/errata.o: relocation R_RISCV_HI20 against `riscv_cbom_block_size' can not be used when making a shared object; recompile with -fPIC
```

## 修改内容

### 文件修改

**文件:** `arch/riscv/errata/Makefile`

**修改前:**
```makefile
ifdef CONFIG_RELOCATABLE
KBUILD_CFLAGS += -fno-pie
endif
```

**修改后:**
```makefile
ifdef CONFIG_RELOCATABLE
# We can't use PIC/PIE when handling early-boot errata parsing, as the kernel
# doesn't have a GOT setup at that point.  So instead just use medany: it's
# usually position-independent, so it should be good enough for the errata
# handling.
KBUILD_CFLAGS += -fno-pie -mcmodel=medany
endif
```

## 技术原理分析

### 1. CONFIG_RELOCATABLE配置

CONFIG_RELOCATABLE是RISC-V内核的一个配置选项，用于构建位置无关的可执行文件(PIE)。当启用此选项时：

- 内核被构建为位置无关可执行文件(PIE)
- 保留所有重定位元数据，允许在运行时将内核二进制文件重定位到不同的虚拟地址
- 由于RISC-V使用RELA重定位格式，即使内核加载到链接时的相同地址，也需要在运行时进行重定位

### 2. 早期启动阶段的问题

在内核早期启动阶段处理errata时存在特殊约束：

- **MMU未启用:** 早期alternatives调用时MMU处于禁用状态
- **GOT/PLT未设置:** 全局偏移表(GOT)和过程链接表(PLT)尚未建立
- **不能访问全局符号:** 无法通过GOT访问全局符号，因为需要重定位

### 3. 代码模型说明

#### PIC/PIE模型的问题
- **PIC (Position Independent Code):** 位置无关代码
- **PIE (Position Independent Executable):** 位置无关可执行文件
- 这些模型依赖GOT/PLT进行符号访问，但在早期启动阶段不可用

#### medany代码模型的优势
- **medany:** RISC-V特有的代码模型
- **通常位置无关:** 在大多数情况下提供位置无关性
- **直接寻址:** 不依赖GOT/PLT，使用直接寻址方式
- **适合早期启动:** 在GOT/PLT未设置时仍可正常工作

### 4. 重定位错误分析

错误信息中提到的符号：

- **`tlb_flush_all_threshold`:** 在sifive errata代码中使用的全局变量
- **`riscv_cbom_block_size`:** 在thead errata代码中使用的全局变量

这些全局变量的访问在PIE模式下需要通过GOT进行，但在早期启动阶段GOT尚未可用，导致链接器报错。

## 相关提交历史

### Fixes标签指向的提交

**Commit:** 8dc2a7e8027f ("riscv: Fix relocatable kernels with early alternatives using -fno-pie")  
**作者:** Alexandre Ghiti <alexghiti@rivosinc.com>  
**日期:** Fri May 26 17:46:30 2023 +0200  

该提交首次引入了`-fno-pie`标志来解决早期alternatives的问题，但没有添加`-mcmodel=medany`，导致了本次patch要解决的链接错误。

### 问题演进

1. **最初问题:** 早期alternatives在PIE模式下无法正常工作
2. **第一次修复:** 添加`-fno-pie`禁用PIE
3. **新问题:** 仍然存在重定位错误，因为没有指定合适的代码模型
4. **最终修复:** 添加`-mcmodel=medany`使用medany代码模型

## 解决方案的有效性

### 为什么medany模型有效

1. **位置无关性:** medany模型在大多数情况下提供位置无关性，满足relocatable内核的需求
2. **直接寻址:** 不依赖GOT/PLT，可以在早期启动阶段正常工作
3. **兼容性:** 与现有的errata处理代码兼容
4. **性能:** 避免了GOT/PLT的间接访问开销

### 影响范围

- **仅影响errata处理代码:** 修改仅应用于`arch/riscv/errata/`目录下的代码
- **仅在CONFIG_RELOCATABLE启用时生效:** 只有在构建relocatable内核时才会应用这些编译标志
- **保持向后兼容:** 不影响非relocatable内核的构建

## 总结

这个patch通过在RISC-V errata处理代码中添加`-mcmodel=medany`编译选项，解决了relocatable内核构建时的链接错误。该修复确保了在早期启动阶段，当GOT/PLT尚未设置时，errata代码仍能正确访问全局符号。这是一个针对性的修复，既保持了relocatable内核的功能，又确保了早期启动代码的正确性。