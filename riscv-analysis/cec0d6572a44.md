# Patch Analysis: cec0d6572a44

## 基本信息

**Commit ID:** cec0d6572a44  
**标题:** perf header: Refactor get_cpuid to take a CPU for ARM  
**作者:** Ian Rogers <irogers@google.com>  
**日期:** 2024年11月  
**子系统:** tools/perf  

## 修改概述

这个patch重构了perf工具中的`get_cpuid`函数，为ARM架构添加了CPU参数支持。主要目的是为了支持ARM big.LITTLE架构中不同类型CPU核心的CPUID获取。

## 详细修改内容

### 1. 函数签名变更

**修改前:**
```c
int __weak get_cpuid(char *buffer __maybe_unused, size_t sz __maybe_unused)
```

**修改后:**
```c
int __weak get_cpuid(char *buffer __maybe_unused, size_t sz __maybe_unused,
                    struct perf_cpu cpu __maybe_unused)
```

### 2. 头文件更新 (tools/perf/util/header.h)

```c
// 函数声明更新
-int get_cpuid(char *buffer, size_t sz);
+int get_cpuid(char *buffer, size_t sz, struct perf_cpu cpu);
```

### 3. 调用点修改

#### tools/perf/util/env.c
```c
int perf_env__read_cpuid(struct perf_env *env)
{
    char cpuid[128];
-   int err = get_cpuid(cpuid, sizeof(cpuid));
+   struct perf_cpu cpu = {-1};
+   int err = get_cpuid(cpuid, sizeof(cpuid), cpu);
```

#### tools/perf/util/header.c
```c
static int write_cpuid(struct feat_fd *ff, struct evlist *evlist)
{
+   struct perf_cpu cpu = perf_cpu_map__min(evlist->core.all_cpus);
    char buffer[64];
    int ret;

-   ret = get_cpuid(buffer, sizeof(buffer));
+   ret = get_cpuid(buffer, sizeof(buffer), cpu);
```

## 技术原理分析

### 1. ARM big.LITTLE架构背景

ARM big.LITTLE架构包含两种不同类型的CPU核心：
- **big核心**: 高性能核心，功耗较高
- **LITTLE核心**: 低功耗核心，性能较低

每种核心类型可能有不同的CPUID/MIDR值，这对性能分析工具来说是一个挑战。

### 2. 问题分析

**原有问题:**
- `get_cpuid`函数没有CPU参数，无法指定从哪个CPU获取CPUID
- 在big.LITTLE系统中，不同类型的核心有不同的CPUID
- 性能事件映射需要准确的CPUID信息来选择正确的PMU事件

**解决方案:**
- 添加`struct perf_cpu cpu`参数，允许指定特定CPU
- 当传入`cpu.cpu = -1`时，保持原有行为（选择第一个可用CPU）
- 当传入有效CPU ID时，从指定CPU获取CPUID

### 3. 实现细节

#### 默认实现（弱符号）
```c
int __weak get_cpuid(char *buffer __maybe_unused, size_t sz __maybe_unused,
                    struct perf_cpu cpu __maybe_unused)
{
    return ENOSYS; /* Not implemented */
}
```

#### 调用策略
1. **env.c中的调用**: 使用`cpu = {-1}`，保持向后兼容
2. **header.c中的调用**: 使用`perf_cpu_map__min(evlist->core.all_cpus)`，获取事件列表中的最小CPU ID

## 相关提交分析

### 1. 后续提交: 538737da9625
**标题:** perf arm64 header: Use cpu argument in get_cpuid

这个提交实现了ARM64架构中`get_cpuid`函数对CPU参数的实际使用：

```c
int get_cpuid(char *buf, size_t sz, struct perf_cpu cpu)
{
    struct perf_cpu_map *cpus;
    int idx;

    if (cpu.cpu != -1)
        return _get_cpuid(buf, sz, cpu);  // 使用指定CPU

    // 回退到遍历所有在线CPU
    cpus = perf_cpu_map__new_online_cpus();
    if (!cpus)
        return EINVAL;

    perf_cpu_map__for_each_cpu(cpu, idx, cpus) {
        int ret = _get_cpuid(buf, sz, cpu);
        if (ret == 0)
            return 0;
    }
    return EINVAL;
}
```

### 2. 后续提交: 494c403ff159
**标题:** perf header: Pass a perf_cpu rather than a PMU to get_cpuid_str

这个提交进一步重构了`get_cpuid_str`函数：

```c
// 函数签名变更
-char *get_cpuid_str(struct perf_pmu *pmu __maybe_unused);
+char *get_cpuid_str(struct perf_cpu cpu);

// 移除了perf_pmu__getcpuid函数
// 添加了get_cpuid_allow_env_override函数
```

## 影响分析

### 1. 架构兼容性
- **x86架构**: 无影响，CPU参数被标记为`__maybe_unused`
- **ARM64架构**: 获得了指定CPU获取CPUID的能力
- **其他架构**: 保持向后兼容

### 2. 功能改进
- 支持big.LITTLE架构的准确CPUID获取
- 为PMU事件映射提供更精确的CPU信息
- 保持了向后兼容性

### 3. 性能影响
- 最小化性能影响
- 在不需要特定CPU信息的场景下，行为保持不变

## 测试验证

根据commit信息，这个patch经过了以下测试：
- **Reviewed-by**: James Clark <james.clark@linaro.org>
- **Tested-by**: Xu Yang <xu.yang_2@nxp.com>

## 总结

这个patch是一个重要的架构改进，主要解决了ARM big.LITTLE架构中CPUID获取的问题。通过添加CPU参数，使得perf工具能够：

1. **精确获取**: 从指定CPU获取CPUID信息
2. **架构支持**: 更好地支持异构CPU架构
3. **向后兼容**: 保持现有代码的兼容性
4. **扩展性**: 为未来的架构扩展提供基础

这个修改为后续的ARM64具体实现和get_cpuid_str函数重构奠定了基础，是一个设计良好的渐进式改进。