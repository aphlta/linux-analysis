# StarFive JH7110 PCIe PHY USB 3.0 配置寄存器补丁分析

## 基本信息

**Commit ID:** 65e8b991267093b759a03c20508d2643a41aa046
**作者:** E Shattow <e@freeshell.de>
**提交者:** Conor Dooley <conor.dooley@microchip.com>
**提交日期:** 2025年2月18日
**标题:** riscv: dts: starfive: jh7110: pciephy0 USB 3.0 configuration registers

## 补丁内容详细分析

### 1. 修改文件
- **文件路径:** `arch/riscv/boot/dts/starfive/jh7110.dtsi`
- **修改节点:** `pciephy0`

### 2. 具体修改内容

```diff
 pciephy0: phy@10210000 {
     compatible = "starfive,jh7110-pcie-phy";
     reg = <0x0 0x10210000 0x0 0x10000>;
     #phy-cells = <0>;
+    starfive,sys-syscon = <&sys_syscon 0x18>;
+    starfive,stg-syscon = <&stg_syscon 0x148 0x1f4>;
 };
```

### 3. 新增属性说明

#### starfive,sys-syscon 属性
- **引用节点:** `sys_syscon` (系统控制寄存器)
- **寄存器偏移:** `0x18`
- **功能:** 控制USB 3.0 PHY连接的系统级配置
- **对应驱动变量:** `sys_phy_connect`

#### starfive,stg-syscon 属性
- **引用节点:** `stg_syscon` (STG系统控制寄存器)
- **寄存器偏移1:** `0x148` - PCIe PHY模式控制
- **寄存器偏移2:** `0x1f4` - PCIe/USB配置控制
- **对应驱动变量:** `stg_pcie_mode`, `stg_pcie_usb`

## 代码修改原理分析

### 1. 系统控制寄存器架构

StarFive JH7110 SoC采用分层的系统控制寄存器架构：

- **sys_syscon:** 系统级控制寄存器，管理全局系统配置
  - 兼容性: `"starfive,jh7110-sys-syscon", "syscon", "simple-mfd"`
  - 基地址: `0x13030000`
  - 大小: `0x10000`

- **stg_syscon:** STG(System Technology Group)控制寄存器，管理特定子系统
  - 兼容性: `"starfive,jh7110-stg-syscon", "syscon"`
  - 基地址: `0x10240000`
  - 大小: `0x1000`

### 2. PCIe PHY驱动实现机制

#### USB 3.0模式配置函数 (`phy_usb3_mode_set`)

```c
static int phy_usb3_mode_set(struct jh7110_pcie_phy *data)
{
    if (!data->stg_syscon || !data->sys_syscon) {
        dev_err(&data->phy->dev, "doesn't support usb3 mode\n");
        return -EINVAL;
    }

    // 设置PHY为USB 3.0模式
    regmap_update_bits(data->stg_syscon, data->stg_pcie_mode,
                       PCIE_PHY_MODE_MASK, PCIE_PHY_MODE);

    // 配置USB 3.0总线宽度
    regmap_update_bits(data->stg_syscon, data->stg_pcie_usb,
                       PCIE_USB3_BUS_WIDTH_MASK, 0);

    // 使能USB 3.0 PHY
    regmap_update_bits(data->stg_syscon, data->stg_pcie_usb,
                       PCIE_USB3_PHY_ENABLE, PCIE_USB3_PHY_ENABLE);

    // 连接USB 3.0 PHY模式
    regmap_update_bits(data->sys_syscon, data->sys_phy_connect,
                       USB_PDRSTN_SPLIT, 0);

    // 配置扩频模式
    writel(PCIE_USB3_PHY_ENABLE, data->regs + PCIE_USB3_PHY_PLL_CTL_OFF);

    return 0;
}
```

#### PCIe模式配置函数 (`phy_pcie_mode_set`)

```c
static void phy_pcie_mode_set(struct jh7110_pcie_phy *data)
{
    // 设置为PCIe模式(默认)
    regmap_update_bits(data->stg_syscon, data->stg_pcie_mode,
                       PCIE_PHY_MODE_MASK, 0);

    // 配置PCIe总线宽度
    regmap_update_bits(data->stg_syscon, data->stg_pcie_usb,
                       PCIE_USB3_BUS_WIDTH_MASK, PCIE_USB3_BUS_WIDTH);

    // 禁用USB 3.0 PHY
    regmap_update_bits(data->stg_syscon, data->stg_pcie_usb,
                       PCIE_USB3_PHY_ENABLE, 0);
}
```

### 3. 寄存器位域定义

```c
// PHY模式控制
#define PCIE_PHY_MODE           BIT(20)     // USB 3.0模式使能
#define PCIE_PHY_MODE_MASK      GENMASK(21, 20)

// USB 3.0配置
#define PCIE_USB3_BUS_WIDTH_MASK    GENMASK(3, 2)
#define PCIE_USB3_BUS_WIDTH         BIT(3)
#define PCIE_USB3_PHY_ENABLE        BIT(4)

// 系统连接控制
#define USB_PDRSTN_SPLIT        BIT(17)     // USB PHY复位分离控制
```

## 补丁功能和意义

### 1. 解决的问题

此补丁解决了StarFive JH7110 SoC中PCIe PHY无法正确配置为USB 3.0模式的问题。在此补丁之前：

- PCIe PHY驱动无法获取必要的系统控制寄存器访问权限
- USB 3.0控制器无法独占使用pciephy0
- 缺少USB 3.0模式的寄存器配置信息

### 2. 实现的功能

- **动态模式切换:** 支持PCIe PHY在PCIe模式和USB 3.0模式之间动态切换
- **寄存器访问:** 提供驱动程序访问系统控制寄存器的能力
- **USB 3.0支持:** 完整支持Cadence USB2.0+USB3.0控制器IP的USB 3.0功能

### 3. 硬件架构支持

StarFive JH7110包含一个Cadence USB2.0+USB3.0控制器IP块，该控制器可以独占使用pciephy0来实现USB 3.0连接。这种设计允许：

- **资源复用:** 同一个PHY硬件可以服务于PCIe或USB 3.0
- **灵活配置:** 根据系统需求动态分配PHY资源
- **成本优化:** 减少硬件PHY数量，降低芯片成本

## 相关提交分析

### 1. 相关修复提交

**Commit:** ec743aeec4ab - "phy: starfive: jh7110-usb: Fix USB 2.0 host occasional detection failure"
**作者:** Hal Feng <hal.feng@starfivetech.com>
**问题:** JH7110 USB 2.0主机偶尔无法检测USB 2.0设备
**解决方案:** 设置Rx时钟门控控制信号为正常功耗模式

### 2. 功能演进时间线

1. **初始PCIe PHY驱动实现** - 支持基本PCIe功能
2. **USB 2.0问题修复** - 解决USB 2.0检测问题
3. **USB 3.0配置支持** (本补丁) - 添加USB 3.0模式配置寄存器
4. **板级支持** - 各开发板启用USB功能

### 3. 板级支持提交

- `708d55db3edb` - "riscv: dts: starfive: jh7110-milkv-mars: enable usb0 host function"
- `03bd268ae048` - "riscv: dts: starfive: jh7110-pine64-star64: enable usb0 host function"
- `817eac165ed4` - "riscv: dts: starfive: jh7110-common: move usb0 config to board dts"

## 技术影响和意义

### 1. 驱动程序兼容性

此补丁确保了PCIe PHY驱动程序能够：
- 正确检测和配置USB 3.0模式
- 与现有PCIe功能保持兼容
- 支持运行时模式切换

### 2. 系统集成

- **设备树绑定:** 遵循标准的设备树绑定规范
- **syscon框架:** 利用Linux syscon框架进行寄存器管理
- **PHY框架:** 集成到标准的PHY子系统

### 3. 未来扩展性

此补丁为未来的功能扩展奠定了基础：
- 支持更多USB 3.0特性
- 可能的USB 3.1/3.2支持
- 更精细的电源管理

## 总结

这个补丁是StarFive JH7110 SoC USB 3.0功能完整实现的关键组成部分。通过添加必要的系统控制寄存器配置，它使得PCIe PHY能够正确地在PCIe和USB 3.0模式之间切换，从而充分发挥了硬件的灵活性和Cadence USB控制器IP的完整功能。这个修改体现了现代SoC设计中资源复用和灵活配置的重要性。