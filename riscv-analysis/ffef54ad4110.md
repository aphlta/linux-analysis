# RISC-V SSTC扩展stimecmp寄存器保存和恢复 Patch 分析

## Commit 信息

**Commit ID:** ffef54ad41101f98ea6dd1dcd71c60bb6b7c8ee9  
**作者:** Nick Hu <nick.hu@sifive.com>  
**提交者:** Alexandre Ghiti <alexghiti@rivosinc.com>  
**作者日期:** Wed Feb 19 19:41:34 2025 +0800  
**标题:** riscv: Add stimecmp save and restore

## Patch 概述

这个patch为RISC-V架构添加了SSTC（Supervisor-mode Timer Compare）扩展中stimecmp寄存器的保存和恢复功能。当CPU进行非保持性挂起（non-retention suspend）时，如果硬件支持SSTC扩展，需要保存和恢复stimecmp寄存器以确保定时器状态的正确性。

## 修改文件统计

- **arch/riscv/include/asm/suspend.h**: +4 行
- **arch/riscv/kernel/suspend.c**: +14 行
- **总计**: 18 行新增

## 详细修改内容分析

### 1. 挂起上下文结构体修改 (arch/riscv/include/asm/suspend.h)

#### 新增的寄存器字段

```c
struct suspend_context {
    /* Saved and restored by low-level functions */
    struct pt_regs regs;
    /* Saved and restored by high-level functions */
    unsigned long envcfg;
    unsigned long tvec;
    unsigned long ie;
#ifdef CONFIG_MMU
    unsigned long satp;
+   unsigned long stimecmp;        // 新增：stimecmp寄存器
+#if __riscv_xlen < 64
+   unsigned long stimecmph;       // 新增：32位系统的高位部分
+#endif
#endif
};
```

**技术原理:**
- **stimecmp**: SSTC扩展的核心寄存器，用于设置定时器比较值
- **stimecmph**: 在32位RISC-V系统中，64位的stimecmp寄存器被分为两个32位寄存器
- 只在CONFIG_MMU启用时添加，因为SSTC扩展主要用于S模式（需要MMU支持）

### 2. CSR保存函数修改 (arch/riscv/kernel/suspend.c)

#### suspend_save_csrs函数增强

```c
void suspend_save_csrs(struct suspend_context *context)
{
    // ... 现有代码 ...
    
#ifdef CONFIG_MMU
+   if (riscv_has_extension_unlikely(RISCV_ISA_EXT_SSTC)) {
+       context->stimecmp = csr_read(CSR_STIMECMP);
+#if __riscv_xlen < 64
+       context->stimecmph = csr_read(CSR_STIMECMPH);
+#endif
+   }
+
    context->satp = csr_read(CSR_SATP);
#endif
}
```

**技术原理:**
- **条件检查**: 使用`riscv_has_extension_unlikely()`检查SSTC扩展是否可用
- **CSR读取**: 使用`csr_read()`宏读取CSR寄存器值
- **架构适配**: 32位系统需要额外读取stimecmph寄存器

### 3. CSR恢复函数修改 (arch/riscv/kernel/suspend.c)

#### suspend_restore_csrs函数增强

```c
void suspend_restore_csrs(struct suspend_context *context)
{
    // ... 现有代码 ...
    
#ifdef CONFIG_MMU
+   if (riscv_has_extension_unlikely(RISCV_ISA_EXT_SSTC)) {
+       csr_write(CSR_STIMECMP, context->stimecmp);
+#if __riscv_xlen < 64
+       csr_write(CSR_STIMECMPH, context->stimecmph);
+#endif
+   }
+
    csr_write(CSR_SATP, context->satp);
#endif
}
```

**技术原理:**
- **对称恢复**: 与保存过程完全对称的恢复操作
- **顺序重要性**: 在恢复SATP之前恢复定时器状态，确保正确的执行顺序

## 技术背景和原理分析

### 1. SSTC扩展简介

**SSTC (Supervisor-mode Timer Compare)** 是RISC-V的一个标准扩展，提供以下功能：

- **stimecmp寄存器**: 64位定时器比较寄存器（CSR地址：0x14D）
- **stimecmph寄存器**: 32位系统中stimecmp的高32位（CSR地址：0x15D）
- **定时器中断**: 当time CSR >= stimecmp时触发定时器中断
- **S模式访问**: 允许S模式直接访问定时器，无需M模式代理

### 2. 挂起/恢复机制

#### 2.1 非保持性挂起

在非保持性挂起（non-retention suspend）中：
- CPU状态完全丢失
- 所有CSR寄存器需要软件保存/恢复
- 包括定时器状态在内的所有上下文都需要处理

#### 2.2 定时器状态保持的重要性

- **中断连续性**: 确保挂起前设置的定时器在恢复后继续有效
- **系统时钟**: 维护系统定时器的准确性
- **调度器**: 保证进程调度的时间片管理正确性

### 3. 架构兼容性处理

#### 3.1 32位vs64位系统

```c
#if __riscv_xlen < 64
    // 32位系统：需要处理stimecmph
    context->stimecmph = csr_read(CSR_STIMECMPH);
#endif
```

**原理说明:**
- **64位系统**: stimecmp是单个64位寄存器
- **32位系统**: stimecmp被分为stimecmp（低32位）和stimecmph（高32位）
- **原子性**: 32位系统需要确保两个寄存器的原子性读写

#### 3.2 扩展检测机制

```c
if (riscv_has_extension_unlikely(RISCV_ISA_EXT_SSTC)) {
    // 只有支持SSTC扩展时才执行
}
```

**检测逻辑:**
- **运行时检测**: 在运行时检查硬件是否支持SSTC扩展
- **条件执行**: 只有在支持时才进行相关操作
- **向后兼容**: 不支持SSTC的硬件不受影响

## 相关提交分析

### 1. 前置提交

这个patch是"Support SSTC while PM operations"系列的一部分：

- **70c93b026ed0**: "clocksource/drivers/timer-riscv: Stop stimecmp when cpu hotplug"
  - 在CPU热插拔时停止stimecmp定时器
  - 防止在电源关闭过程中产生待处理的定时器中断

### 2. 系列patch的协同作用

1. **热插拔支持**: 70c93b026ed0处理CPU热插拔场景
2. **挂起/恢复支持**: ffef54ad4110处理挂起/恢复场景
3. **完整的电源管理**: 两个patch共同提供完整的SSTC电源管理支持

## 代码实现细节

### 1. CSR寄存器定义

在`arch/riscv/include/asm/csr.h`中定义：

```c
#define CSR_STIMECMP    0x14D    // S模式定时器比较寄存器
#define CSR_STIMECMPH   0x15D    // S模式定时器比较寄存器高位（32位系统）
```

### 2. 扩展检测

```c
// 检查SSTC扩展是否可用
riscv_has_extension_unlikely(RISCV_ISA_EXT_SSTC)
```

这个函数检查：
- 设备树中的ISA字符串
- 运行时检测到的硬件能力
- 内核配置选项

### 3. 内存布局影响

新增字段对`suspend_context`结构体的影响：
- **64位系统**: 增加8字节（stimecmp）
- **32位系统**: 增加16字节（stimecmp + stimecmph）
- **对齐**: 保持结构体的自然对齐

## 性能和兼容性分析

### 1. 性能影响

- **挂起开销**: 增加1-2个CSR读操作（微秒级）
- **恢复开销**: 增加1-2个CSR写操作（微秒级）
- **内存开销**: 每个CPU增加8-16字节上下文存储
- **运行时开销**: 零运行时开销（只在挂起/恢复时执行）

### 2. 兼容性保证

- **硬件兼容**: 不支持SSTC的硬件完全不受影响
- **软件兼容**: 现有代码无需修改
- **ABI兼容**: 不影响用户空间ABI

## 测试和验证

### 1. 功能测试

- 验证SSTC扩展的正确检测
- 测试挂起/恢复过程中定时器状态的保持
- 确认32位和64位系统的正确行为

### 2. 兼容性测试

- 在不支持SSTC的硬件上测试
- 验证向后兼容性
- 确认不影响现有功能

## 总结

这个patch是RISC-V架构电源管理功能的重要增强，具有以下特点：

1. **功能完整性**: 为SSTC扩展提供完整的挂起/恢复支持
2. **架构适配**: 正确处理32位和64位系统的差异
3. **兼容性**: 保持与不支持SSTC硬件的完全兼容
4. **性能优化**: 最小化性能开销，只在必要时执行
5. **代码质量**: 遵循内核编码规范，代码清晰易懂

该patch为RISC-V生态系统中支持SSTC扩展的硬件提供了必要的软件基础设施，是RISC-V架构走向成熟的重要一步。