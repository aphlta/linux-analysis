# RISC-V Vector Crypto Extension Validation Patch Analysis

## Commit Information
- **Commit ID**: 38077ec8fc11fa62e85a3a7630cfa9f2b8fd9f65
- **Author**: Conor Dooley <conor.dooley@microchip.com>
- **Date**: Wed Mar 12 13:11:45 2025 +0000
- **Title**: RISC-V: add vector crypto extension validation checks
- **Signed-off-by**: Alexandre Ghiti <alexghiti@rivosinc.com>

## 1. Patch修改内容详细分析

### 1.1 修改文件
- **文件**: `arch/riscv/kernel/cpufeature.c`
- **修改统计**: 33行新增，16行删除

### 1.2 核心修改内容

#### 1.2.1 新增验证函数
```c
static int riscv_ext_vector_crypto_validate(const struct riscv_isa_ext_data *data,
                                           const unsigned long *isa_bitmap)
{
    if (!IS_ENABLED(CONFIG_RISCV_ISA_V))
        return -EINVAL;

    /*
     * It isn't the kernel's job to check that the binding is correct, so
     * it should be enough to check that any of the vector extensions are
     * enabled, which in-turn means that vector is usable in this kernel
     */
    if (!__riscv_isa_extension_available(isa_bitmap, RISCV_ISA_EXT_ZVE32X))
        return -EPROBE_DEFER;

    return 0;
}
```

#### 1.2.2 扩展定义修改
将所有vector crypto扩展从普通的`__RISCV_ISA_EXT_DATA`和`__RISCV_ISA_EXT_BUNDLE`宏修改为带验证的版本：

**修改前**:
```c
__RISCV_ISA_EXT_DATA(zvkb, RISCV_ISA_EXT_ZVKB),
__RISCV_ISA_EXT_DATA(zvkg, RISCV_ISA_EXT_ZVKG),
__RISCV_ISA_EXT_BUNDLE(zvkn, riscv_zvkn_bundled_exts),
// ... 其他扩展
```

**修改后**:
```c
__RISCV_ISA_EXT_DATA_VALIDATE(zvkb, RISCV_ISA_EXT_ZVKB, riscv_ext_vector_crypto_validate),
__RISCV_ISA_EXT_DATA_VALIDATE(zvkg, RISCV_ISA_EXT_ZVKG, riscv_ext_vector_crypto_validate),
__RISCV_ISA_EXT_BUNDLE_VALIDATE(zvkn, riscv_zvkn_bundled_exts, riscv_ext_vector_crypto_validate),
// ... 其他扩展
```

#### 1.2.3 涉及的Vector Crypto扩展
以下扩展都添加了验证回调：
- `zvkb` - Vector Crypto Bit-manipulation
- `zvkg` - Vector Crypto GCM/GMAC
- `zvkn` - Vector Crypto NIST Suite (bundle)
- `zvknc` - Vector Crypto NIST Suite + Carryless multiply (bundle)
- `zvkned` - Vector Crypto NIST Suite AES
- `zvkng` - Vector Crypto NIST Suite + GCM (bundle)
- `zvknha` - Vector Crypto NIST Suite SHA-2 256
- `zvknhb` - Vector Crypto NIST Suite SHA-2 512
- `zvks` - Vector Crypto ShangMi Suite (bundle)
- `zvksc` - Vector Crypto ShangMi Suite + Carryless multiply (bundle)
- `zvksed` - Vector Crypto ShangMi Suite SM4
- `zvksh` - Vector Crypto ShangMi Suite SM3
- `zvksg` - Vector Crypto ShangMi Suite + GCM (bundle)
- `zvkt` - Vector Crypto Scalar cryptography
- `zvbb` - Vector Crypto Bit-manipulation (superset)
- `zvbc` - Vector Crypto Carryless multiply

## 2. 代码修改原理分析

### 2.1 问题背景
在此patch之前，RISC-V vector crypto扩展的检测存在一个问题：
- `riscv_isa_extension_available(<vector crypto>)`会在支持这些扩展但vector本身被内核禁用的系统上返回true
- 这导致了不一致的行为，用户期望不需要同时检查vector和特定的crypto扩展

### 2.2 解决方案
通过引入验证回调机制：
1. **依赖检查**: 确保vector crypto扩展只有在vector扩展可用时才被启用
2. **配置检查**: 验证`CONFIG_RISCV_ISA_V`配置选项已启用
3. **基础扩展检查**: 确保至少有`ZVE32X`（最基础的vector扩展）可用

### 2.3 验证逻辑
```c
// 1. 检查内核配置
if (!IS_ENABLED(CONFIG_RISCV_ISA_V))
    return -EINVAL;  // 内核不支持vector

// 2. 检查基础vector扩展
if (!__riscv_isa_extension_available(isa_bitmap, RISCV_ISA_EXT_ZVE32X))
    return -EPROBE_DEFER;  // 延迟探测，等待vector扩展就绪
```

### 2.4 设计哲学
根据commit message，内核的职责是：
- **不是**：检查设备树绑定的正确性
- **是**：确保vector在某种形式下可用
- **简化**：只需检查任何vector扩展是否启用，这意味着vector在内核中可用

## 3. 相关提交分析

### 3.1 前置提交
- **Commit**: 9324571e9eea ("RISC-V: add vector extension validation checks")
- **关系**: 这是基础设施提交，引入了validation callback机制
- **作用**: 为vector扩展添加了验证检查框架

### 3.2 技术依赖
此patch依赖于Clement的新validation callbacks机制，该机制允许：
- 在扩展启用前进行依赖检查
- 支持延迟探测（`-EPROBE_DEFER`）
- 提供一致的扩展检测行为

## 4. 技术影响分析

### 4.1 行为变化
**修改前**:
```c
if (riscv_isa_extension_available(RISCV_ISA_EXT_ZVKB)) {
    // 可能在vector被禁用时仍然返回true
    use_crypto_extension();
}
```

**修改后**:
```c
if (riscv_isa_extension_available(RISCV_ISA_EXT_ZVKB)) {
    // 只有在vector真正可用时才返回true
    use_crypto_extension();
}
```

### 4.2 规范依据
Unpriv规范声明：
> The Zvknhb and Zvbc Vector Crypto Extensions --and accordingly the
> composite extensions Zvkn, Zvknc, Zvkng, and Zvksc-- require a Zve64x
> base, or application ("V") base Vector Extension. All of the other
> Vector Crypto Extensions can be built on any embedded (Zve*) or
> application ("V") base Vector Extension.

### 4.3 实现策略
内核选择了简化的验证策略：
- 不区分不同crypto扩展的具体基础要求（Zve32x vs Zve64x）
- 统一检查`ZVE32X`作为最低要求
- 将精确的依赖检查留给设备树绑定

## 5. 安全和稳定性考虑

### 5.1 防止误用
- 防止在vector不可用时使用vector crypto指令
- 避免系统崩溃或未定义行为

### 5.2 一致性保证
- 确保扩展检测函数的行为符合用户期望
- 简化用户空间和内核代码的扩展检查逻辑

### 5.3 向前兼容
- 保持现有API不变
- 只改变内部验证逻辑

## 6. 总结

这个patch通过引入vector crypto扩展的验证检查，解决了扩展检测不一致的问题。主要贡献包括：

1. **问题修复**: 解决了vector被禁用时crypto扩展仍被报告为可用的问题
2. **一致性提升**: 使扩展检测行为更符合用户期望
3. **安全增强**: 防止在不支持的系统上误用vector crypto指令
4. **代码简化**: 用户不再需要同时检查vector和crypto扩展

该patch是RISC-V vector crypto支持完善过程中的重要一步，提高了系统的可靠性和用户体验。