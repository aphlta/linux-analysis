# RISC-V架构迁移到通用内置DTB规则的Patch分析

## Commit信息

- **Commit ID**: 82e81b89501a9f19a3a0b0d7d9641d86c1956284
- **标题**: riscv: migrate to the generic rule for built-in DTB
- **作者**: Masahiro Yamada <masahiroy@kernel.org>
- **提交日期**: 2024年12月22日 09:08:25 +0900
- **合并者**: Alexandre Ghiti <alexghiti@rivosinc.com>
- **合并日期**: 2025年3月18日 13:30:13 +0000
- **邮件列表链接**: https://lore.kernel.org/r/20241222000836.2578171-1-masahiroy@kernel.org

## Patch概述

这个patch将RISC-V架构迁移到使用通用的内置DTB(Device Tree Blob)构建规则，这是内核构建系统标准化的一部分。该patch引用了commit 654102df2ac2，该commit为内置DTB提供了通用支持。

## 详细修改内容

### 1. arch/riscv/Kconfig修改

```diff
 config BUILTIN_DTB
        bool "Built-in device tree"
        depends on OF && NONPORTABLE
+       select GENERIC_BUILTIN_DTB
        help
          Build a device tree into the Linux image.
          This option should be selected if no bootloader is being used.
          If unsure, say N.
 
-config BUILTIN_DTB_SOURCE
+config BUILTIN_DTB_NAME
        string "Built-in device tree source"
        depends on BUILTIN_DTB
```

**修改说明**:
- 在`BUILTIN_DTB`配置选项中添加了`select GENERIC_BUILTIN_DTB`，启用通用DTB构建支持
- 将配置选项`BUILTIN_DTB_SOURCE`重命名为`BUILTIN_DTB_NAME`，保持跨架构的一致性

### 2. arch/riscv/boot/dts/Makefile修改

```diff
 subdir-y += thead
-
-obj-$(CONFIG_BUILTIN_DTB) := $(addsuffix .dtb.o, $(CONFIG_BUILTIN_DTB_SOURCE))
```

**修改说明**:
- 删除了架构特定的DTB构建规则
- 移除了基于`CONFIG_BUILTIN_DTB_SOURCE`的目标文件生成规则
- 这些功能现在由通用的DTB构建系统处理

### 3. 配置文件更新

#### arch/riscv/configs/nommu_k210_defconfig
```diff
 CONFIG_BUILTIN_DTB=y
-CONFIG_BUILTIN_DTB_SOURCE="canaan/k210_generic"
+CONFIG_BUILTIN_DTB_NAME="canaan/k210_generic"
```

#### arch/riscv/configs/nommu_k210_sdcard_defconfig
```diff
 CONFIG_BUILTIN_DTB=y
-CONFIG_BUILTIN_DTB_SOURCE="canaan/k210_generic"
+CONFIG_BUILTIN_DTB_NAME="canaan/k210_generic"
```

**修改说明**:
- 更新了K210相关的默认配置文件
- 将`CONFIG_BUILTIN_DTB_SOURCE`替换为`CONFIG_BUILTIN_DTB_NAME`
- 保持了相同的DTB文件路径"canaan/k210_generic"

## 技术原理分析

### 1. 通用DTB构建系统的工作原理

通用DTB构建系统(GENERIC_BUILTIN_DTB)的引入是为了标准化各个架构的DTB构建过程。根据commit 654102df2ac2的实现，该系统提供了以下功能：

- **统一的构建规则**: 所有架构使用相同的DTB构建逻辑
- **自动化处理**: 通过脚本自动生成DTB对象文件
- **符号生成**: 为每个DTB文件生成标准的开始和结束符号
- **链接集成**: 自动将DTB对象文件链接到vmlinux中

### 2. DTB嵌入机制

内置DTB的工作流程：

1. **编译阶段**: DTB源文件(.dts)被编译成二进制DTB文件(.dtb)
2. **包装阶段**: DTB文件被包装成汇编代码，生成.builtin-dtbs.S文件
3. **符号生成**: 为每个DTB生成`__dtb_<name>_begin`和`__dtb_<name>_end`符号
4. **链接阶段**: DTB对象文件被链接到vmlinux的.dtb.init.rodata段中
5. **运行时访问**: 内核可以通过符号访问嵌入的DTB数据

### 3. 配置选项重命名的意义

将`BUILTIN_DTB_SOURCE`重命名为`BUILTIN_DTB_NAME`有以下考虑：

- **语义准确性**: "NAME"比"SOURCE"更准确地描述了配置的作用
- **跨架构一致性**: 统一了不同架构的配置选项命名
- **避免混淆**: 明确表示这是DTB的名称而不是源文件路径

## 相关提交分析

### 1. 基础提交 654102df2ac2

这个提交引入了通用DTB构建支持，包括：
- 在顶层Makefile中添加了DTB构建规则
- 实现了DTB包装脚本
- 提供了GENERIC_BUILTIN_DTB配置选项

### 2. 其他架构的迁移

类似的迁移已经在多个架构中进行：
- **nios2**: commit 3b8241f64c46
- **sh**: commit 21bcc49974c2  
- **LoongArch**: commit c91ddab57991
- **ARC**: commit 3b7f793acc13

这表明这是一个系统性的内核构建系统改进项目。

## 影响分析

### 1. 正面影响

- **代码简化**: 移除了架构特定的DTB构建代码
- **维护性提升**: 统一的构建规则更容易维护
- **一致性**: 跨架构的配置选项命名保持一致
- **扩展性**: 新架构可以更容易地采用DTB支持

### 2. 兼容性

- **向后兼容**: 现有的DTB文件路径保持不变
- **配置迁移**: 需要更新配置文件中的选项名称
- **构建兼容**: 构建过程对用户透明

### 3. 特定影响

对于RISC-V架构：
- **K210支持**: 保持了对Kendryte K210 SoC的DTB支持
- **NoMMU配置**: 确保了NoMMU配置的正确性
- **嵌入式应用**: 改进了嵌入式RISC-V系统的DTB处理

## 技术细节

### 1. DTB文件路径解析

配置值"canaan/k210_generic"对应的文件路径：
- 源文件: `arch/riscv/boot/dts/canaan/k210_generic.dts`
- 编译后: `arch/riscv/boot/dts/canaan/k210_generic.dtb`
- 符号名: `__dtb_canaan_k210_generic_begin` / `__dtb_canaan_k210_generic_end`

### 2. 构建流程变化

**之前的流程**:
```makefile
obj-$(CONFIG_BUILTIN_DTB) := $(addsuffix .dtb.o, $(CONFIG_BUILTIN_DTB_SOURCE))
```

**现在的流程**:
- 通用脚本处理CONFIG_BUILTIN_DTB_NAME
- 自动生成.builtin-dtbs.S文件
- 统一链接到vmlinux

## 总结

这个patch是内核构建系统现代化的重要一步，它：

1. **标准化了DTB构建**: 将RISC-V架构迁移到通用DTB构建系统
2. **提升了代码质量**: 移除了重复的架构特定代码
3. **改善了维护性**: 统一的构建规则更容易维护和扩展
4. **保持了兼容性**: 确保现有配置和DTB文件继续工作
5. **促进了一致性**: 跨架构的配置选项命名保持一致

该patch是一个典型的重构改进，虽然功能上没有变化，但显著提升了代码的组织性和可维护性。对于RISC-V生态系统，这种标准化有助于更好地支持各种嵌入式和服务器应用场景。