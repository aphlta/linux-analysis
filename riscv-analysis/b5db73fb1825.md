# RISC-V STACKLEAK 功能支持补丁分析

## 1. 基本信息

**Commit ID**: b5db73fb1825  
**标题**: riscv: enable HAVE_ARCH_STACKLEAK  
**作者**: Jisheng Zhang <jszhang@kernel.org>  
**提交者**: Palmer Dabbelt <palmer@rivosinc.com>  
**提交日期**: 2024年7月26日  

## 2. 补丁概述

本补丁为RISC-V架构添加了STACKLEAK功能支持。STACKLEAK是一个内核安全特性，当内核返回用户空间时，会用毒化值填充内核栈，以防止内核栈信息泄露。

## 3. 修改内容详细分析

### 3.1 架构配置修改 (arch/riscv/Kconfig)

```diff
+       select HAVE_ARCH_STACKLEAK
```

**作用**: 为RISC-V架构启用STACKLEAK功能支持。这个配置选项表明RISC-V架构具备了支持STACKLEAK功能的必要条件。

**原理**: 
- `HAVE_ARCH_STACKLEAK`是一个架构特定的配置选项
- 启用后允许在该架构上使用GCC STACKLEAK插件
- 需要架构提供相应的汇编代码支持

### 3.2 异常返回路径修改 (arch/riscv/kernel/entry.S)

```diff
+#ifdef CONFIG_GCC_PLUGIN_STACKLEAK
+       call    stackleak_erase_on_task_stack
+#endif
```

**插入位置**: `ret_from_exception`函数中，在返回用户空间之前

**作用**: 
- 在内核返回用户空间时调用栈清理函数
- 只有当从内核空间返回到用户空间时才执行(通过`bnez s0, 1f`检查)
- 确保内核栈被安全地清理

**执行流程**:
1. 检查异常来源(用户空间 vs 内核空间)
2. 如果是从用户空间进入内核，在返回时执行栈清理
3. 调用`stackleak_erase_on_task_stack`函数清理栈内容
4. 继续正常的异常返回流程

### 3.3 EFI Stub编译选项修改 (drivers/firmware/efi/libstub/Makefile)

```diff
-cflags-$(CONFIG_RISCV)         += -fpic -DNO_ALTERNATIVE -mno-relax
+cflags-$(CONFIG_RISCV)         += -fpic -DNO_ALTERNATIVE -mno-relax \
+                                  $(DISABLE_STACKLEAK_PLUGIN)
```

**作用**: 在EFI stub代码中禁用STACKLEAK插件

**原因**: 
- EFI stub运行在特殊环境中，不在内核保护范围内
- EFI stub代码需要与UEFI固件交互，有特殊的栈管理需求
- STACKLEAK插件可能干扰EFI stub的正常运行

### 3.4 头文件依赖修改 (arch/riscv/include/asm/thread_info.h)

```diff
+#include <linux/sizes.h>
```

**作用**: 添加对`linux/sizes.h`的包含

**原因**: STACKLEAK功能可能需要使用该头文件中定义的大小常量

## 4. STACKLEAK 功能原理

### 4.1 工作机制

1. **编译时插桩**: GCC STACKLEAK插件在编译时向函数中插入代码
2. **栈使用跟踪**: 跟踪每个任务的最低栈使用位置
3. **栈清理**: 在返回用户空间时清理未使用的栈空间
4. **毒化填充**: 使用特定的毒化值填充栈空间

### 4.2 安全价值

- **防止信息泄露**: 清理栈中可能包含敏感信息的区域
- **缓解栈溢出**: 使栈溢出攻击更难利用
- **增强内核安全**: 提供额外的防护层

### 4.3 性能影响

- **运行时开销**: 每次系统调用返回时需要清理栈
- **编译时开销**: GCC插件增加编译时间
- **内存开销**: 需要额外的元数据跟踪栈使用

## 5. 测试验证

作者在以下平台进行了测试:
- QEMU模拟器
- Milk-V Duo开发板

测试方法:
```bash
echo STACKLEAK_ERASING > /sys/kernel/debug/provoke-crash/DIRECT
```

测试结果显示STACKLEAK功能正常工作，能够正确跟踪和清理栈空间:

```
[   38.675575] lkdtm: Performing direct entry STACKLEAK_ERASING
[   38.678448] lkdtm: stackleak stack usage:
[   38.678448]   high offset: 288 bytes
[   38.678448]   current:     496 bytes
[   38.678448]   lowest:      1328 bytes
[   38.678448]   tracked:     1328 bytes
[   38.678448]   untracked:   448 bytes
[   38.678448]   poisoned:    14312 bytes
[   38.678448]   low offset:  8 bytes
[   38.689887] lkdtm: OK: the rest of the thread stack is properly erased
```

## 6. 相关提交历史

这个补丁是RISC-V架构安全功能完善的一部分，与以下功能相关:
- KASAN (Kernel Address Sanitizer) 支持
- UBSAN (Undefined Behavior Sanitizer) 支持
- CFI (Control Flow Integrity) 支持

## 7. 技术实现细节

### 7.1 异常返回路径选择

在`ret_from_exception`函数中，通过以下代码判断是否需要执行栈清理:

```assembly
REG_L s0, PT_STATUS(sp)
#ifdef CONFIG_RISCV_M_MODE
    li t0, SR_MPP
    and s0, s0, t0
#else
    andi s0, s0, SR_SPP
#endif
bnez s0, 1f
```

- 检查状态寄存器中的特权级别位
- 如果是从用户空间进入内核(SPP=0)，则执行栈清理
- 如果是内核内部异常(SPP=1)，则跳过栈清理

### 7.2 栈清理时机

栈清理在以下时机执行:
- 系统调用返回
- 中断处理返回
- 异常处理返回
- 任何从内核空间返回用户空间的路径

### 7.3 与其他架构的对比

| 架构 | STACKLEAK支持 | 实现方式 |
|------|---------------|----------|
| x86_64 | ✓ | 在syscall返回路径中调用 |
| ARM64 | ✓ | 在异常返回路径中调用 |
| RISC-V | ✓ (本补丁) | 在异常返回路径中调用 |

## 8. 影响和意义

### 8.1 安全性提升
- 为RISC-V平台提供了重要的内核安全特性
- 与其他主流架构(x86, ARM64)的安全功能对齐
- 增强了RISC-V在安全敏感场景中的适用性

### 8.2 生态系统完善
- 完善了RISC-V架构的内核安全功能
- 为RISC-V平台的企业级应用提供了更好的安全保障
- 推动了RISC-V生态系统的成熟

### 8.3 开发者影响
- 开发者可以在RISC-V平台上使用STACKLEAK功能
- 提供了与其他架构一致的安全开发体验
- 支持安全敏感应用的开发需求

## 9. 潜在问题和注意事项

### 9.1 性能考虑
- 每次系统调用都会有额外的栈清理开销
- 在高频系统调用场景下可能影响性能
- 建议在性能敏感的生产环境中进行充分测试

### 9.2 兼容性
- 需要GCC支持STACKLEAK插件
- 某些特殊的内核模块可能需要禁用STACKLEAK
- EFI stub等特殊代码路径需要特殊处理

### 9.3 调试影响
- 栈内容被清理可能影响某些调试场景
- 需要在调试时考虑STACKLEAK的影响

## 10. 总结

这个补丁成功为RISC-V架构添加了STACKLEAK功能支持，通过在异常返回路径中添加栈清理调用，实现了内核栈的安全清理。修改涉及架构配置、汇编代码、编译选项等多个方面，体现了对RISC-V架构特性的深入理解和细致的工程实现。

主要贡献:
1. **安全性增强**: 为RISC-V提供了重要的内核安全特性
2. **架构完善**: 使RISC-V与主流架构的安全功能对齐
3. **生态推进**: 推动RISC-V在企业级和安全敏感场景的应用

这一功能的添加显著提升了RISC-V平台的内核安全性，是RISC-V架构走向成熟的重要里程碑。