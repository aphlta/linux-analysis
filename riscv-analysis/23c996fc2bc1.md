# RISC-V Vendor Extensions 支持补丁分析

## Commit 信息
- **Commit ID**: 23c996fc2bc1978a02c64eddb90b4ab5d309c8df
- **作者**: Charlie Jenkins <charlie@rivosinc.com>
- **日期**: 2024年7月19日
- **标题**: riscv: Extend cpufeature.c to detect vendor extensions

## 补丁概述

这个补丁为RISC-V架构引入了vendor extensions（厂商扩展）的独立检测和管理机制。主要目标是将厂商特定的ISA扩展从标准扩展中分离出来，为每个厂商提供独立的扩展管理框架。

## 核心修改内容

### 1. 新增核心数据结构

#### vendor_extensions.h
- 定义了 `riscv_isavendorinfo` 结构体，用于存储每个厂商的ISA扩展位图
- 引入 `riscv_isa_vendor_ext_data_list` 结构体，管理厂商扩展数据列表
- 设置 `RISCV_ISA_VENDOR_EXT_MAX = 32`，限制每个厂商最多支持32个扩展
- 定义 `RISCV_VENDOR_EXT_ALTERNATIVES_BASE = 0x8000`，用于区分厂商扩展和errata

#### 关键API函数
```c
bool __riscv_isa_vendor_extension_available(int cpu, unsigned long vendor, unsigned int bit);
#define riscv_isa_vendor_extension_available(vendor, ext)
#define riscv_cpu_isa_vendor_extension_available(cpu, vendor, ext)
```

### 2. Andes厂商扩展支持

#### andes.h
- 定义 `RISCV_ISA_VENDOR_EXT_XANDESPMU = 0`
- 设置Andes厂商的最大扩展数量为32

#### andes.c
- 实现Andes厂商扩展数据结构
- 将xandespmu扩展从标准扩展迁移到厂商扩展

### 3. 配置系统重构

#### Kconfig.vendor（新文件）
```kconfig
config RISCV_ISA_VENDOR_EXT
    bool

config RISCV_ISA_VENDOR_EXT_ANDES
    bool "Andes vendor extension support"
    select RISCV_ISA_VENDOR_EXT
    default y

config RISCV_ISA_VENDOR_EXT_THEAD
    bool "T-Head vendor extension support"
    select RISCV_ISA_VENDOR_EXT
    default y
```

### 4. cpufeature.c核心逻辑修改

#### ISA字符串解析改进
- 在 `riscv_parse_isa_string()` 中添加对'x'/'X'前缀的处理
- 对于ACPI禁用的情况，发出警告建议使用riscv,isa-extensions
- 跳过vendor extensions的解析，避免错误处理

#### Alternative机制扩展
- 修改 `riscv_cpufeature_patch_func()` 支持vendor extensions
- 通过patch_id区分标准扩展和厂商扩展：
  - `id < RISCV_ISA_EXT_MAX`: 标准扩展
  - `id >= RISCV_VENDOR_EXT_ALTERNATIVES_BASE`: 厂商扩展

#### hwcap.h重构
- 移除 `RISCV_ISA_EXT_XANDESPMU = 74`
- 重新编号后续的标准扩展ID

### 5. 厂商扩展检测机制

#### vendor_extensions.c
- 实现全局厂商扩展列表管理
- 支持条件编译，根据CONFIG选项包含不同厂商
- 提供统一的厂商扩展可用性检查接口

```c
struct riscv_isa_vendor_ext_data_list *riscv_isa_vendor_ext_list[] = {
#ifdef CONFIG_RISCV_ISA_VENDOR_EXT_ANDES
    &riscv_isa_vendor_ext_list_andes,
#endif
#ifdef CONFIG_RISCV_ISA_VENDOR_EXT_THEAD
    &riscv_isa_vendor_ext_list_thead,
#endif
};
```

### 6. PMU驱动适配

#### riscv_pmu_sbi.c
- 将 `riscv_isa_extension_available(NULL, XANDESPMU)` 替换为
- `riscv_isa_vendor_extension_available(ANDES_VENDOR_ID, XANDESPMU)`
- 更新ALTERNATIVE宏调用，使用新的厂商扩展标识符

### 7. Errata系统集成

#### errata文件修改
- 在andes/errata.c、sifive/errata.c、thead/errata.c中添加vendor_extensions.h包含
- 添加BUILD_BUG_ON检查，确保errata编号不与vendor extension基址冲突

## 技术原理分析

### 1. 分离设计原理

传统方案将所有扩展（标准+厂商）都放在同一个`riscv_isa_ext`数组中，存在以下问题：
- 厂商扩展与标准扩展混合，难以管理
- 无法为不同厂商提供独立的配置选项
- 扩展ID空间容易冲突

新方案通过以下机制解决：
- 每个厂商维护独立的扩展数据结构
- 使用vendor_id区分不同厂商
- 通过CONFIG选项实现条件编译

### 2. Alternative机制扩展

RISC-V的Alternative机制用于运行时代码替换，原本只支持标准扩展。补丁通过以下方式扩展支持：

```c
if (id < RISCV_ISA_EXT_MAX) {
    // 标准扩展处理
    if (!__riscv_isa_extension_available(NULL, id))
        continue;
} else if (id >= RISCV_VENDOR_EXT_ALTERNATIVES_BASE) {
    // 厂商扩展处理
    if (!__riscv_isa_vendor_extension_available(VENDOR_EXT_ALL_CPUS, vendor,
                                               id - RISCV_VENDOR_EXT_ALTERNATIVES_BASE))
        continue;
}
```

### 3. 位图管理机制

每个厂商扩展使用独立的位图管理：
- `per_hart_isa_bitmap[NR_CPUS]`: 每个CPU核心的扩展位图
- `all_harts_isa_bitmap`: 所有CPU核心共同支持的扩展位图

这种设计支持异构CPU系统，可以精确跟踪每个核心的扩展支持情况。

### 4. 配置系统层次化

```
RISCV_ISA_VENDOR_EXT (总开关)
├── RISCV_ISA_VENDOR_EXT_ANDES
│   └── 具体Andes扩展配置
└── RISCV_ISA_VENDOR_EXT_THEAD
    └── 具体T-Head扩展配置
```

## 影响分析

### 1. 向后兼容性
- 标准扩展API保持不变
- 现有的标准扩展检测逻辑不受影响
- xandespmu从标准扩展迁移到厂商扩展，需要更新相关代码

### 2. 性能影响
- 增加了厂商扩展检测的开销，但通过条件编译可以最小化
- Alternative机制的扩展增加了少量运行时检查
- 位图操作效率高，对性能影响微乎其微

### 3. 可扩展性
- 为未来添加新厂商提供了清晰的框架
- 每个厂商最多支持32个扩展，对大多数场景足够
- 配置系统支持细粒度控制

## 相关提交分析

这个补丁是RISC-V vendor extension支持系列的第一个补丁，为后续补丁奠定了基础：

1. **架构基础**: 建立了vendor extension的基本框架
2. **Andes支持**: 将xandespmu迁移到新框架
3. **配置系统**: 提供了灵活的配置选项
4. **API设计**: 定义了统一的vendor extension检测接口

后续补丁可能包括：
- 在/proc/cpuinfo中显示vendor extensions
- 添加更多厂商的支持
- 扩展vendor extension的功能

## 文件修改统计

```
 arch/riscv/Kconfig                               |   2 +
 arch/riscv/Kconfig.vendor                        |  19 ++++++++
 arch/riscv/errata/andes/errata.c                 |   3 ++
 arch/riscv/errata/sifive/errata.c                |   3 ++
 arch/riscv/errata/thead/errata.c                 |   3 ++
 arch/riscv/include/asm/cpufeature.h              |  25 ++++++++++
 arch/riscv/include/asm/hwcap.h                   |  25 +++++-----
 arch/riscv/include/asm/vendor_extensions.h       |  49 +++++++++++++++++++
 arch/riscv/include/asm/vendor_extensions/andes.h |  19 ++++++++
 arch/riscv/kernel/Makefile                       |   2 +
 arch/riscv/kernel/cpufeature.c                   | 143 +++++++++++++++++++++++++++++++++++++++----------------
 arch/riscv/kernel/vendor_extensions.c            |  56 ++++++++++++++++++++++
 arch/riscv/kernel/vendor_extensions/Makefile     |   3 ++
 arch/riscv/kernel/vendor_extensions/andes.c      |  18 +++++++
 drivers/perf/riscv_pmu_sbi.c                     |  10 ++--
 15 files changed, 324 insertions(+), 56 deletions(-)
```

## 总结

这个补丁通过引入独立的vendor extension管理框架，解决了RISC-V生态系统中厂商扩展管理的关键问题。主要贡献包括：

1. **架构清晰**: 将厂商扩展与标准扩展分离，提供清晰的管理边界
2. **可配置性**: 通过Kconfig提供细粒度的厂商扩展控制
3. **可扩展性**: 为未来添加新厂商和扩展提供了标准化框架
4. **兼容性**: 保持了与现有代码的向后兼容
5. **性能优化**: 通过条件编译和高效的位图操作最小化性能影响

这个补丁为RISC-V生态系统中vendor extension的标准化管理奠定了重要基础，有助于促进RISC-V架构的生态发展。特别是对于Andes Technology等厂商的自定义扩展支持，提供了更加规范和可维护的实现方式。