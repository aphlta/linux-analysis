# RISC-V VDSO调试信息保留补丁分析

## 基本信息

**Commit ID:** 7587a3602bf2f12e798ea955b17521948ddb56a5  
**作者:** Changbin Du <changbin.du@huawei.com>  
**提交日期:** 2024年6月11日  
**标题:** riscv: vdso: do not strip debugging info for vdso.so.dbg  

## 补丁概述

这个补丁修改了RISC-V架构的VDSO（Virtual Dynamic Shared Object）构建过程，移除了对`vdso.so.dbg`文件的调试信息剥离操作，以保留调试符号用于性能分析和调试目的。

## 详细修改内容

### 修改的文件
- `arch/riscv/kernel/vdso/Makefile`

### 具体变更
```diff
-LDFLAGS_vdso.so.dbg = -shared -S -soname=linux-vdso.so.1 \
+LDFLAGS_vdso.so.dbg = -shared -soname=linux-vdso.so.1 \
        --build-id=sha1 --hash-style=both --eh-frame-hdr
```

**关键变更：** 移除了链接器标志中的`-S`参数。

## 技术原理分析

### VDSO机制简介

VDSO（Virtual Dynamic Shared Object）是Linux内核提供的一种机制，它将某些系统调用的实现直接映射到用户空间，避免了用户态到内核态的切换开销。RISC-V架构的VDSO主要包含以下功能：

1. **时间相关系统调用**：`gettimeofday`、`clock_gettime`等
2. **CPU信息获取**：`getcpu`
3. **信号处理**：`rt_sigreturn`
4. **缓存刷新**：`flush_icache`
5. **硬件探测**：`hwprobe`、`sys_hwprobe`

### VDSO构建流程

RISC-V VDSO的构建过程包含两个主要文件：

1. **vdso.so.dbg**：包含调试信息的完整版本
2. **vdso.so**：从vdso.so.dbg剥离调试信息后的生产版本

构建流程：
```makefile
# 1. 链接生成带调试信息的版本
$(obj)/vdso.so.dbg: $(obj)/vdso.lds $(obj-vdso) FORCE
	$(call if_changed,vdsold_and_check)

# 2. 从调试版本剥离生成生产版本
$(obj)/%.so: OBJCOPYFLAGS := -S
$(obj)/%.so: $(obj)/%.so.dbg FORCE
	$(call if_changed,objcopy)
```

### -S参数的作用机制

`-S`参数是链接器的一个标志，其作用是：
- **完整名称**：`--strip-all`
- **功能**：不从源文件复制重定位和符号信息
- **效果**：移除所有调试符号、符号表和重定位信息

在修改前，`vdso.so.dbg`文件在链接时就被剥离了调试信息，这与其作为"调试版本"的设计目的相矛盾。

## 问题背景分析

### 性能分析工具的需求

现代性能分析工具（如perf）需要调试信息来提供有意义的分析结果：

1. **perf-annotate**：需要调试信息来显示源代码行与汇编指令的对应关系
2. **符号解析**：需要符号表来将地址转换为函数名
3. **调用栈分析**：需要调试信息来构建准确的调用栈

### 其他架构的对比

通过分析其他架构的实现，发现：

**x86架构**：
```makefile
# x86的实现中，vdso.so.dbg在链接时不使用-S参数
$(obj)/vdso64.so.dbg: $(obj)/vdso.lds $(vobjs) FORCE
	$(call if_changed,vdso_and_check)

# 只在生成最终的.so文件时才剥离调试信息
$(obj)/%.so: OBJCOPYFLAGS := -S --remove-section __ex_table
$(obj)/%.so: $(obj)/%.so.dbg FORCE
	$(call if_changed,objcopy)
```

**MIPS架构**：
```makefile
# MIPS也采用类似的两阶段构建方式
$(obj)/vdso.so.dbg.raw: $(obj)/vdso.lds $(obj-vdso) FORCE
	$(call if_changed,vdsold_and_vdso_check)

$(obj)/%.so.raw: OBJCOPYFLAGS := -S
$(obj)/%.so.raw: $(obj)/%.so.dbg.raw FORCE
	$(call if_changed,objcopy)
```

这表明RISC-V的原始实现是不一致的，其他架构都保留了.dbg版本的调试信息。

## 修改影响分析

### 正面影响

1. **调试能力增强**：
   - perf-annotate可以正常工作
   - 其他调试工具可以获得更详细的信息
   - 开发者可以更容易地分析VDSO性能问题

2. **架构一致性**：
   - 与其他架构的实现保持一致
   - 符合Linux内核的设计惯例

3. **工具链兼容性**：
   - 提高与现有性能分析工具的兼容性
   - 支持更丰富的调试场景

### 潜在影响

1. **文件大小**：
   - `vdso.so.dbg`文件会变大（包含调试信息）
   - 但不影响运行时性能，因为实际使用的是`vdso.so`

2. **构建时间**：
   - 可能略微增加构建时间
   - 影响很小，因为VDSO代码量不大

## 相关提交分析

### 时间线分析

在2024年的RISC-V VDSO相关提交中：

1. **7f7f6f7ad654** (2024年早期)：Makefile清理工作
2. **7587a3602bf2** (2024-06-11)：本次修改
3. **bf40167d54d5** (2024年后期)：防止编译器插入memset调用
4. **c6898d66fd19** (2024年后期)：检查VDSO不包含动态重定位

### 修复链条

这个修改是RISC-V VDSO完善过程中的一环：
- 首先修复调试信息问题（本patch）
- 然后解决编译器优化问题
- 最后加强重定位检查

## 代码审查信息

**审查者：**
- Cyril Bur <cyrilbur@tenstorrent.com>
- Alexandre Ghiti <alexghiti@rivosinc.com>

**维护者：**
- Palmer Dabbelt <palmer@rivosinc.com>

**邮件列表链接：**
https://lore.kernel.org/r/20240611040947.3024710-1-changbin.du@huawei.com

## 技术细节深入

### 链接器标志详解

修改后的链接器标志：
```makefile
LDFLAGS_vdso.so.dbg = -shared -soname=linux-vdso.so.1 \
	--build-id=sha1 --hash-style=both --eh-frame-hdr
```

各参数含义：
- `-shared`：创建共享库
- `-soname=linux-vdso.so.1`：设置共享库的soname
- `--build-id=sha1`：生成SHA1构建ID
- `--hash-style=both`：同时生成GNU和SYSV哈希表
- `--eh-frame-hdr`：生成异常处理框架头

### 构建系统集成

这个修改与内核构建系统的集成：

1. **目标文件生成**：
   ```makefile
   targets += vdso.so vdso.so.dbg vdso.lds
   ```

2. **依赖关系**：
   ```makefile
   $(obj)/vdso.o: $(obj)/vdso.so
   ```

3. **符号偏移生成**：
   ```makefile
   include/generated/vdso-offsets.h: $(obj)/vdso.so.dbg FORCE
   	$(call if_changed,vdsosym)
   ```

## 总结

这个补丁是一个重要的修复，它：

1. **解决了实际问题**：使perf-annotate等工具能够正常工作
2. **提高了一致性**：与其他架构的实现保持一致
3. **改善了开发体验**：为RISC-V开发者提供更好的调试支持
4. **风险很低**：只影响调试版本文件，不影响运行时性能

这个修改体现了Linux内核开发中对工具链支持和开发者体验的重视，是RISC-V架构走向成熟的重要一步。

## 建议和最佳实践

1. **对于内核开发者**：
   - 在设计新架构的VDSO时，应该参考成熟架构的实现
   - 确保调试版本真正包含调试信息

2. **对于性能分析**：
   - 可以使用vdso.so.dbg进行详细的性能分析
   - 结合perf-annotate等工具获得更好的分析结果

3. **对于发行版维护者**：
   - 考虑在调试包中包含vdso.so.dbg文件
   - 为开发者提供完整的调试支持