# RISC-V VDSO 通用存储实现迁移分析

## Commit 信息
- **Commit ID**: 46fe55b204bf
- **作者**: Thomas Weißschuh <thomas.weissschuh@linutronix.de>
- **日期**: 2025年2月4日
- **标题**: riscv: vdso: Switch to generic storage implementation

## 补丁概述

这个patch将RISC-V架构的VDSO（Virtual Dynamic Shared Object）实现从自定义的存储机制迁移到通用的存储实现。这是一个架构重构的一部分，旨在统一不同架构间的VDSO数据存储方式，提高代码的可维护性和共享性。

## 主要修改内容

### 1. 配置变更 (arch/riscv/Kconfig)

```diff
-       select ARCH_HAS_VDSO_TIME_DATA
+       select ARCH_HAS_VDSO_ARCH_DATA if GENERIC_VDSO_DATA_STORE
+       select GENERIC_VDSO_DATA_STORE if MMU
```

**修改原理**:
- 移除了 `ARCH_HAS_VDSO_TIME_DATA` 配置，这是旧的架构特定时间数据配置
- 添加了 `ARCH_HAS_VDSO_ARCH_DATA` 配置，用于支持通用架构特定数据
- 添加了 `GENERIC_VDSO_DATA_STORE` 配置，启用通用VDSO数据存储机制

### 2. 头文件修改 (arch/riscv/include/asm/vdso.h)

```diff
-#define __VVAR_PAGES    2
+#define __VDSO_PAGES    4
```

**修改原理**:
- 将页面数量从2页增加到4页，以适应通用存储机制的布局
- 重命名宏名称以更好地反映其用途

### 3. VDSO核心实现重构 (arch/riscv/kernel/vdso.c)

**主要变更**:
- 移除了自定义的 `vdso_data_store` 联合体定义
- 删除了架构特定的时间命名空间处理代码
- 简化了VVAR映射逻辑
- 使用通用的 `linux/vdso_datastore.h` 头文件

**删除的代码**:
```c
// 删除了自定义的数据存储
static union vdso_data_store vdso_data_store __page_aligned_data;
struct vdso_data *vdso_data = vdso_data_store.data;

// 删除了架构特定的时间命名空间处理
struct vdso_data *arch_get_vdso_data(void *vvar_page);
int vdso_join_timens(struct task_struct *task, struct time_namespace *ns);
```

### 4. 硬件探测代码更新

#### hwprobe.c 修改:
```diff
-       const struct vdso_data *vd = __arch_get_vdso_data();
-       const struct arch_vdso_time_data *avd = &vd->arch_data;
+       const struct vdso_arch_data *avd = &vdso_u_arch_data;
```

#### sys_hwprobe.c 修改:
```diff
-       struct vdso_data *vd = __arch_get_k_vdso_data();
-       struct arch_vdso_time_data *avd = &vd->arch_data;
+       struct vdso_arch_data *avd = vdso_k_arch_data;
```

**修改原理**:
- 统一了用户空间和内核空间的数据访问方式
- 使用通用的 `vdso_arch_data` 结构体替代架构特定的时间数据结构
- 简化了数据访问路径，直接使用全局符号而非通过函数调用

### 5. 链接脚本更新 (arch/riscv/kernel/vdso/vdso.lds.S)

```diff
-       PROVIDE(_vdso_data = . - __VVAR_PAGES * PAGE_SIZE);
-#ifdef CONFIG_TIME_NS
-       PROVIDE(_timens_data = _vdso_data + PAGE_SIZE);
-#endif
+       VDSO_VVAR_SYMS
```

**修改原理**:
- 使用通用的 `VDSO_VVAR_SYMS` 宏替代手动定义的符号
- 这个宏在 `vdso/datapage.h` 中定义，提供了标准化的符号布局
- 自动处理时间命名空间和其他VDSO数据的符号定义

## 技术原理深度分析

### 1. 通用VDSO数据存储架构

通用VDSO数据存储机制将VDSO数据分为几个标准化的页面：

```c
enum vdso_pages {
    VDSO_TIME_PAGE_OFFSET,      // 时间数据页
    VDSO_TIMENS_PAGE_OFFSET,    // 时间命名空间页
    VDSO_RNG_PAGE_OFFSET,       // 随机数据页
    VDSO_ARCH_PAGES_START,      // 架构特定数据起始页
    VDSO_ARCH_PAGES_END,        // 架构特定数据结束页
    VDSO_NR_PAGES               // 总页数
};
```

### 2. 数据访问模式变化

**旧模式**:
- 通过 `__arch_get_vdso_data()` 函数获取VDSO数据
- 架构特定数据嵌入在时间数据结构中
- 每个架构需要实现自己的数据存储和映射逻辑

**新模式**:
- 直接通过全局符号访问数据：`vdso_u_arch_data` (用户空间) 和 `vdso_k_arch_data` (内核空间)
- 架构特定数据独立存储
- 使用通用的映射和故障处理逻辑

### 3. 内存布局优化

新的布局提供了更好的缓存局部性和更清晰的数据分离：

```
旧布局:
[VDSO数据页] [时间命名空间页]

新布局:
[时间数据页] [时间命名空间页] [随机数据页] [架构特定数据页...]
```

## 相关提交分析

这个patch是一个更大的VDSO重构系列的一部分：

1. **365841e1557a**: "vdso: Add generic architecture-specific data storage"
   - 引入了通用的架构特定数据存储机制
   - 为多页架构数据做准备（如LoongArch）

2. **51d6ca373f45**: "vdso: Add generic random data storage"
   - 添加了通用的随机数据存储

3. **df7fcbefa710**: "vdso: Add generic time data storage"
   - 添加了通用的时间数据存储

4. **0b3bc3354eb9**: "arm64: vdso: Switch to generic storage implementation"
   - ARM64架构的类似迁移

## 影响和优势

### 1. 代码维护性提升
- 减少了架构特定的重复代码
- 统一了不同架构间的VDSO实现
- 简化了新架构的VDSO支持添加

### 2. 功能扩展性
- 为未来的VDSO功能（如随机数生成）提供了标准化基础
- 支持多页架构数据的需求
- 更好的时间命名空间支持

### 3. 性能优化
- 更直接的数据访问路径
- 更好的缓存局部性
- 减少了函数调用开销

## 潜在风险和注意事项

1. **ABI兼容性**: 虽然这是内核内部重构，但需要确保用户空间程序的兼容性
2. **内存使用**: 页面数量从2增加到4，增加了内存使用
3. **调试复杂性**: 通用化可能使特定架构的调试变得更复杂

## 总结

这个patch代表了Linux内核VDSO子系统的一次重要重构，将RISC-V架构从自定义实现迁移到通用实现。这种变化提高了代码的可维护性和可扩展性，为未来的VDSO功能扩展奠定了基础。虽然增加了一些内存开销，但带来的架构统一和维护简化的好处是显著的。