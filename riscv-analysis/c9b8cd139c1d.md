# RISC-V hwprobe: 导出最高虚拟用户空间地址 (c9b8cd139c1d)

## 基本信息

- **Commit ID**: c9b8cd139c1d
- **标题**: riscv: hwprobe: export highest virtual userspace address
- **作者**: Clément Léger <cleger@rivosinc.com>
- **提交者**: Palmer Dabbelt <palmer@rivosinc.com>
- **日期**: 2024年

## 修改概述

这个patch为RISC-V架构的hwprobe系统调用添加了一个新的key，用于导出用户空间可用的最高虚拟地址。这个功能主要是为了满足用户空间应用程序（如OpenJDK）的需求，这些应用程序需要知道指针的可用位数来实现自己的逻辑。

## 详细修改内容

### 1. 新增hwprobe key定义

**文件**: `arch/riscv/include/uapi/asm/hwprobe.h`

```c
#define RISCV_HWPROBE_KEY_ZICBOZ_BLOCK_SIZE    6
+#define RISCV_HWPROBE_KEY_HIGHEST_VIRT_ADDRESS 7
/* Increase RISCV_HWPROBE_MAX_KEY when adding items. */
```

- 添加了新的hwprobe key `RISCV_HWPROBE_KEY_HIGHEST_VIRT_ADDRESS`，值为7
- 这个key用于查询用户空间可访问的最高虚拟地址

### 2. 新增user_max_virt_addr宏定义

**文件**: `arch/riscv/include/asm/processor.h`

```c
#define STACK_TOP              DEFAULT_MAP_WINDOW

+#ifdef CONFIG_MMU
+#define user_max_virt_addr() arch_get_mmap_end(ULONG_MAX, 0, 0)
+#else
+#define user_max_virt_addr() 0
+#endif /* CONFIG_MMU */
```

- 在MMU配置下，`user_max_virt_addr()`返回`arch_get_mmap_end(ULONG_MAX, 0, 0)`
- 在非MMU配置下，返回0
- `arch_get_mmap_end`宏实际返回`STACK_TOP_MAX`值

### 3. hwprobe实现

**文件**: `arch/riscv/kernel/sys_hwprobe.c`

```c
#include <asm/cacheflush.h>
#include <asm/cpufeature.h>
#include <asm/hwprobe.h>
+#include <asm/processor.h>
#include <asm/sbi.h>
```

添加了processor.h头文件的包含，以使用`user_max_virt_addr()`宏。

```c
case RISCV_HWPROBE_KEY_ZICBOZ_BLOCK_SIZE:
    if (hwprobe_ext0_has(cpus, RISCV_HWPROBE_EXT_ZICBOZ))
        pair->value = riscv_cboz_block_size;
    break;
+case RISCV_HWPROBE_KEY_HIGHEST_VIRT_ADDRESS:
+    pair->value = user_max_virt_addr();
+    break;
```

在`hwprobe_one_pair`函数中添加了新的case分支，处理`RISCV_HWPROBE_KEY_HIGHEST_VIRT_ADDRESS`查询。

## 技术原理分析

### 1. 虚拟地址空间布局

RISC-V架构中，用户空间虚拟地址的最大值由以下因素决定：

- **64位系统**: `TASK_SIZE_64 = PGDIR_SIZE * PTRS_PER_PGD / 2`
- **32位系统**: `TASK_SIZE_32 = 0x80000000 - PAGE_SIZE`
- **MMU配置**: 通过`arch_get_mmap_end`宏返回`STACK_TOP_MAX`

### 2. arch_get_mmap_end宏机制

```c
#define arch_get_mmap_end(addr, len, flags)  \
({                                       \
    STACK_TOP_MAX;                      \
})
```

这个宏忽略了传入的参数，直接返回`STACK_TOP_MAX`值，这代表了用户空间可映射的最高地址。

### 3. hwprobe系统调用机制

hwprobe是RISC-V特有的系统调用，允许用户空间程序查询处理器的硬件特性和配置信息。新增的key扩展了这个接口，提供虚拟地址空间信息。

## 应用场景和需求背景

### 1. OpenJDK的需求

根据commit message中的链接，OpenJDK在RISC-V平台上需要知道指针的可用位数：

- OpenJDK使用指针的高位MSB来存储额外的元数据信息
- 需要知道有多少位可以安全使用而不影响地址的有效性
- 之前通过解析`/proc/cpuinfo`中的"mmu=svxx"字符串来获取这个信息

### 2. 稳定接口的需要

- `/proc/cpuinfo`的解析方式不够稳定，格式可能变化
- hwprobe提供了更稳定、标准化的查询接口
- 避免了字符串解析的复杂性和潜在的兼容性问题

### 3. 虚拟化环境考虑

使用`arch_get_mmap_end`而不是直接的MMU模式信息，是因为：
- 反映的是逻辑上可用的地址空间，而不是硬件原始支持的模式
- 在虚拟化环境中可能存在差异
- 提供了更准确的用户空间可用地址范围

## 相关提交分析

这个patch是RISC-V hwprobe功能持续演进的一部分。相关的提交包括：

1. **hwprobe基础设施**: 早期建立hwprobe系统调用框架
2. **扩展支持**: 陆续添加各种硬件特性查询支持
3. **性能相关**: 添加了向量操作、未对齐访问等性能特性查询
4. **用户空间需求**: 本patch响应了实际应用程序的需求

## 影响和意义

### 1. 用户空间应用优化

- 允许JVM等运行时系统更好地利用指针空间
- 支持指针压缩、标记指针等优化技术
- 提高内存使用效率

### 2. 平台兼容性

- 为不同RISC-V配置提供统一的查询接口
- 支持32位和64位系统的差异化处理
- 考虑了MMU和非MMU配置

### 3. 生态系统发展

- 促进了RISC-V平台上高级语言运行时的发展
- 为其他需要类似功能的应用程序提供了标准接口
- 增强了RISC-V平台的软件生态系统

## 总结

这个patch通过在hwprobe系统调用中添加`RISCV_HWPROBE_KEY_HIGHEST_VIRT_ADDRESS` key，为用户空间应用程序提供了查询最高可用虚拟地址的标准接口。这个功能主要服务于需要利用指针高位进行优化的应用程序（如OpenJDK），替代了之前不稳定的`/proc/cpuinfo`解析方式。实现上通过`user_max_virt_addr()`宏调用`arch_get_mmap_end()`来获取实际的地址空间限制，考虑了MMU配置和虚拟化环境的影响。这个改进增强了RISC-V平台的软件生态系统，为高性能应用程序的开发提供了更好的支持。