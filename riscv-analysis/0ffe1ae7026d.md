# RISC-V pgprot_nx实现分析报告

## 1. Commit信息

**Commit ID**: 0ffe1ae7026dd129d86318388ed62ba61f085730  
**作者**: Jisheng Zhang <jszhang@kernel.org>  
**日期**: Wed Nov 22 00:06:37 2023 +0800  
**标题**: riscv: mm: implement pgprot_nx  

## 2. 修改内容概述

本patch为RISC-V架构实现了`pgprot_nx`函数，该函数用于移除页面保护属性中的执行权限，从而支持W^X（Write XOR Execute）保护机制。

### 2.1 具体代码修改

在`arch/riscv/include/asm/pgtable.h`文件中添加了以下代码：

```c
#define pgprot_nx pgprot_nx
static inline pgprot_t pgprot_nx(pgprot_t _prot)
{
    return __pgprot(pgprot_val(_prot) & ~_PAGE_EXEC);
}
```

## 3. 技术原理分析

### 3.1 W^X保护机制

W^X（Write XOR Execute）是一种重要的安全机制，其核心原则是：
- 内存页面要么可写，要么可执行，但不能同时具备两种权限
- 这种机制可以有效防止代码注入攻击和缓冲区溢出利用

### 3.2 pgprot_nx函数作用

`pgprot_nx`函数的作用是：
1. **移除执行权限**: 通过清除`_PAGE_EXEC`位来禁止页面执行
2. **保持其他权限**: 保留读写等其他权限位不变
3. **支持vmap安全**: 确保通过`vmap()`映射的页面不具备执行权限

### 3.3 RISC-V页表权限位

根据`arch/riscv/include/asm/pgtable-bits.h`的定义：

```c
#define _PAGE_PRESENT   (1 << 0)    /* 页面存在 */
#define _PAGE_READ      (1 << 1)    /* 可读 */
#define _PAGE_WRITE     (1 << 2)    /* 可写 */
#define _PAGE_EXEC      (1 << 3)    /* 可执行 */
#define _PAGE_USER      (1 << 4)    /* 用户页面 */
#define _PAGE_GLOBAL    (1 << 5)    /* 全局页面 */
#define _PAGE_ACCESSED  (1 << 6)    /* 访问位 */
#define _PAGE_DIRTY     (1 << 7)    /* 脏位 */
```

`pgprot_nx`函数通过`& ~_PAGE_EXEC`操作清除第3位（执行权限位）。

## 4. 相关提交分析

### 4.1 触发提交 cca98e9f8b5e

本patch的实现是为了响应commit `cca98e9f8b5e`（"mm: enforce that vmap can't map pages executable"），该提交的主要变化：

1. **修改vmap函数**: 在`mm/vmalloc.c`中，`vmap()`函数调用`map_kernel_range()`时使用`pgprot_nx(prot)`而不是直接使用`prot`
2. **强制W^X保护**: 确保通过vmap映射的页面不能同时具备写和执行权限
3. **多架构支持**: 为ARM64、x86等架构都实现了相应的`pgprot_nx`函数

### 4.2 架构对比

不同架构的`pgprot_nx`实现方式：

**ARM64架构**:
```c
#define pgprot_nx(prot) \
    __pgprot_modify(prot, 0, PTE_PXN)
```

**x86架构**:
```c
static inline pgprot_t pgprot_nx(pgprot_t prot)
{
    return __pgprot(pgprot_val(prot) | _PAGE_NX);
}
```

**RISC-V架构**:
```c
static inline pgprot_t pgprot_nx(pgprot_t _prot)
{
    return __pgprot(pgprot_val(_prot) & ~_PAGE_EXEC);
}
```

注意：x86使用`|`操作设置NX位，而RISC-V使用`&`操作清除EXEC位，这是因为两种架构对"不可执行"的表示方式不同。

## 5. 安全意义

### 5.1 防护效果

1. **防止代码注入**: 攻击者无法在可写内存区域执行恶意代码
2. **缓解ROP/JOP攻击**: 减少可用的代码片段
3. **内核安全增强**: 提高内核内存管理的安全性

### 5.2 应用场景

1. **动态内存映射**: 通过`vmap()`创建的映射
2. **模块加载**: 内核模块的内存布局
3. **设备驱动**: 驱动程序的内存保护

## 6. 实现细节

### 6.1 函数设计

```c
#define pgprot_nx pgprot_nx  // 定义宏，表明架构已实现此函数
static inline pgprot_t pgprot_nx(pgprot_t _prot)
{
    return __pgprot(pgprot_val(_prot) & ~_PAGE_EXEC);
}
```

- 使用`static inline`确保性能
- 通过`pgprot_val()`获取保护位的数值
- 使用位运算清除执行权限
- 通过`__pgprot()`重新构造保护属性

### 6.2 与通用实现的关系

在`include/asm-generic/pgtable.h`中有默认实现：
```c
#ifndef pgprot_nx
#define pgprot_nx(prot) (prot)
#endif
```

RISC-V的实现覆盖了这个默认的空实现，提供了真正的功能。

## 7. 测试和验证

### 7.1 功能验证

可以通过以下方式验证实现：
1. 检查vmap映射的页面权限
2. 尝试执行映射内存中的代码
3. 使用内核调试工具检查页表项

### 7.2 性能影响

- 函数为内联实现，运行时开销极小
- 仅在创建映射时执行，不影响正常内存访问性能
- 安全收益远大于性能开销

## 8. 总结

本patch为RISC-V架构实现了`pgprot_nx`函数，这是一个重要的安全增强功能：

1. **完善了RISC-V的内存保护机制**，使其与其他主流架构保持一致
2. **支持W^X保护策略**，提高了系统安全性
3. **实现简洁高效**，通过清除执行权限位实现功能
4. **与内核安全框架集成**，支持vmap等核心功能的安全增强

这个patch虽然代码量不大，但对RISC-V架构的安全性具有重要意义，是内核安全机制在RISC-V平台的重要完善。